<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自動平衡排休系統（結算時數與特休平衡版）</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體以保持現代感和清晰度 */
        body { font-family: 'Inter', sans-serif; }
        /* 讓表格在小螢幕上可以滾動 */
        .table-container { overflow-x: auto; }
        
        /* --- 表格基礎樣式 (邊框加粗, 字體縮小以適應 A4) --- */
        .schedule-table { border-collapse: collapse; width: 100%; }
        .schedule-table th, .schedule-table td {
            min-width: 40px; /* 確保日期列有最小寬度 */
            padding: 4px 2px; /* 縮小 Padding */
            text-align: center;
            font-size: 0.7rem; /* 稍小的字體適合表格 */
            background-color: white; 
            color: #1f2937; 
            border: 1px solid #333; /* **粗黑邊框** */
            box-sizing: border-box; 
        }
        
        .schedule-table th { 
            background-color: #f3f4f6;
            color: #1f2937; 
            font-weight: 700; 
            border: 1px solid #333; /* **粗黑邊框** */
            position: sticky;
            top: 0;
            z-index: 12; /* 確保表頭覆蓋右側統計列 */
        }

        /* 固定列的基礎樣式 (LEFT) */
        .schedule-table th.sticky-col, .schedule-table td.sticky-col {
            position: sticky;
            z-index: 4; /* Higher z-index for fixed columns to cover body cells */
            background-color: #e5e7eb !important; /* 確保粘性列為淺灰色背景 */
        }
        
        /* 定義多個 sticky 列的層級和位置 (LEFT) */
        .sticky-col-1 { left: 0px; min-width: 80px; }
        .sticky-col-2 { left: 80px; min-width: 70px; }
        .sticky-col-3 { left: 150px; min-width: 70px; }
        
        /* ------------------------------------------------ */
        /* FIXED COLUMNS ON THE RIGHT */
        
        /* Excess Hours (R3) - rightmost */
        .sticky-col-excess {
            position: sticky;
            right: 0px;
            z-index: 10; 
            background-color: #d1d5db !important;
            min-width: 80px !important;
        }

        /* Total Rest Days (R1) */
        .sticky-col-r1 {
            position: sticky;
            right: 80px; /* 80px (Excess) */
            z-index: 9;
            background-color: #dbeafe !important; 
            min-width: 60px !important;
        }

        /* ------------------------------------------------ */


        /* 週末表頭微弱區分 */
        .weekend-header {
            background-color: #e5e7eb !important; 
        }
        
        /* 班別/假別的功能性樣式 (使用灰階和邊框) */
        .rest-day-text { font-weight: 700; color: #1f2937; background-color: #f7f7f7 !important; } 
        .annual-leave-text { font-weight: 700; color: #1f2937; background-color: #ebebeb !important; border: 1px solid #999; } 
        .wedding-leave-text { font-weight: 700; color: #1f2937; background-color: #fce7f3 !important; border: 1px solid #c084fc; } 

        .pre-assigned-text { font-style: italic; font-weight: 600; background-color: #f0f0f0 !important; } 
        .fixed-rotation-text { font-weight: 700; color: #1f2937; background-color: #e5e5e5 !important; border: 1px solid #777; } 

        /* --- 列印優化 (A4 Fit) --- */
        @media print {
            body { 
                margin: 0; 
                padding: 0; 
                font-size: 8pt; 
            }
            .max-w-6xl { max-width: none !important; }
            main { 
                box-shadow: none !important; 
                border: none !important; 
                padding: 0 !important; 
            }
            header, .grid-cols-3, #scheduleOutput > .flex { display: none !important; } /* 隱藏輸入控制項和摘要框 */
            #scheduleOutput { 
                display: block !important; 
                margin-top: 0 !important; 
                padding-top: 0 !important; 
            }
            .table-container { 
                overflow-x: hidden !important; 
                box-shadow: none !important;
                border: none !important;
            }
            .schedule-table th, .schedule-table td {
                font-size: 7pt !important; /* 極小的字體適合 A4 fit */
                padding: 1px 0px !important; /* 最小化 padding */
                min-width: 40px !important; /* 保持日期列寬度 */
                border: 1px solid #000 !important; /* **列印邊框調整** */
            }
            .schedule-table th { 
                background-color: #ccc !important; 
                -webkit-print-color-adjust: exact; 
                color: #000 !important;
            }
            
            /* 禁用 sticky 行為以進行列印 (所有 sticky 相關類別) */
            .schedule-table th.sticky-col, 
            .schedule-table td.sticky-col, 
            .sticky-col-excess, .sticky-col-r1 { /* Only keep r1 and excess in the print-safe list */
                position: static !important;
                left: auto !important;
                right: auto !important;
                z-index: auto !important;
            }
            /* 確保背景顏色在列印時被保留 (灰階列印) */
            .bg-blue-50\/70, .bg-yellow-100\/70 { background-color: #f0f0ff !important; -webkit-print-color-adjust: exact; } 
            .rest-day-text, .annual-leave-text, .pre-assigned-text, .fixed-rotation-text, .wedding-leave-text { 
                background-color: #f7f7f7 !important; 
                -webkit-print-color-adjust: exact; 
                font-weight: bold !important; /* 加粗字體 */
            }
        }

    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#1e3a8a', 
                        'secondary': '#3b82f6', 
                        'teal-700': '#0d9488', 
                        'teal-100': '#e6fffa',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">
    <!-- Firebase 腳本必須是 type="module" -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 全域變數
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig) {
            window.app = initializeApp(firebaseConfig);
            window.db = getFirestore(window.app);
            window.auth = getAuth(window.app);
            window.userId = null; // 在登入後設定

            // --- 狀態更新函數 (與主腳本共享) ---
            window.updateSaveStatus = (message, type) => {
                const statusDiv = document.getElementById('saveStatus');
                if (statusDiv) {
                    statusDiv.textContent = message;
                    statusDiv.className = 'text-xs font-medium px-2 py-1 rounded-full absolute top-2 right-2 transition-opacity duration-300';
                    statusDiv.classList.remove('opacity-0', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700', 'bg-gray-100', 'text-gray-600');
                    if (type === 'success') {
                        statusDiv.classList.add('bg-green-100', 'text-green-700', 'opacity-100');
                    } else if (type === 'error') {
                        statusDiv.classList.add('bg-red-100', 'text-red-700', 'opacity-100');
                    } else { // info
                        statusDiv.classList.add('bg-gray-100', 'text-gray-600', 'opacity-100');
                    }
                    setTimeout(() => statusDiv.classList.add('opacity-0'), 3000); // 3秒後隱藏
                }
            };
            
            // --- 儲存函數 (Save) ---
            window.saveData = async () => {
                if (!window.db || !window.userId || !window.datesWithTypes || !window.requirements) return;
                
                // NEW: 在儲存前，從動態欄位更新隱藏的 carryOverInput 欄位
                updateCarryOverTextFromInputs(false); 
                updateAnnualLeaveTextFromInputs(false); // NEW: Update annual leave balance
                updateSettlementHoursTextFromInputs(false); // NEW: Update settlement hours

                window.updateRequirementsFromInputs();
                
                const staffText = document.getElementById('staffNames').value;
                const serviceDeskStaffName = document.getElementById('serviceDeskStaffSelect').value;
                const referralCenterStaffName = document.getElementById('referralCenterStaffSelect').value;
                const regStaff1Name = document.getElementById('regStaff1Select').value;
                const regStaff2Name = document.getElementById('regStaff2Select').value;
                const rotationStartDate = document.getElementById('rotationStartDate').value;
                const carryOverStatusText = document.getElementById('carryOverInput').value;
                const annualLeaveStatusText = document.getElementById('annualLeaveBalanceText').value; // NEW
                const settlementHoursStatusText = document.getElementById('settlementHoursText').value; // NEW
                const prevSdStaffName = document.getElementById('prevSdStaffSelect').value;
                const prevRcStaffName = document.getElementById('prevRcStaffSelect').value;
                const monthlyStandardHours = document.getElementById('monthlyStandardHours').value;


                const datesText = JSON.stringify(window.datesWithTypes.map(item => ({
                    dateObj: item.dateObj.toISOString(), // 儲存為 ISO 字串
                    type: item.type
                })));
                const requirementsText = JSON.stringify(window.requirements);
                const restShiftName = document.getElementById('restShiftName').value;
                const preAssignedShiftsText = JSON.stringify(window.preAssignedShifts);

                const docRef = doc(window.db, "artifacts", appId, "users", window.userId, "schedule_data", "current_schedule");
                
                try {
                    await setDoc(docRef, {
                        staffText: staffText,
                        serviceDeskStaffName: serviceDeskStaffName,
                        referralCenterStaffName: referralCenterStaffName,
                        regStaff1Name: regStaff1Name,
                        regStaff2Name: regStaff2Name,
                        rotationStartDate: rotationStartDate,
                        carryOverStatusText: carryOverStatusText,
                        annualLeaveStatusText: annualLeaveStatusText, // NEW
                        settlementHoursStatusText: settlementHoursStatusText, // NEW
                        prevSdStaffName: prevSdStaffName,
                        prevRcStaffName: prevRcStaffName,
                        monthlyStandardHours: monthlyStandardHours,
                        
                        datesWithTypes: datesText,
                        requirements: requirementsText,
                        restShiftName: restShiftName,
                        preAssignedShifts: preAssignedShiftsText,
                        timestamp: new Date().toISOString()
                    });
                    console.log("Data saved successfully.");
                    window.updateSaveStatus('已自動儲存', 'success');
                } catch (e) {
                    console.error("Error saving document: ", e);
                    window.updateSaveStatus('儲存失敗', 'error');
                }
            };

            // --- 載入函數 (Load) ---
            window.loadData = async () => {
                if (!window.db || !window.userId) return;

                const docRef = doc(window.db, "artifacts", appId, "users", window.userId, "schedule_data", "current_schedule");
                try {
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                        document.getElementById('staffNames').value = data.staffText || '';
                        document.getElementById('serviceDeskStaffSelect').value = data.serviceDeskStaffName || '';
                        document.getElementById('referralCenterStaffSelect').value = data.referralCenterStaffName || '';
                        document.getElementById('regStaff1Select').value = data.regStaff1Name || '';
                        document.getElementById('regStaff2Select').value = data.regStaff2Name || '';
                        document.getElementById('rotationStartDate').value = data.rotationStartDate || '';
                        document.getElementById('carryOverInput').value = data.carryOverStatusText || '';
                        document.getElementById('annualLeaveBalanceText').value = data.annualLeaveStatusText || ''; // NEW
                        document.getElementById('settlementHoursText').value = data.settlementHoursStatusText || ''; // NEW
                        document.getElementById('prevSdStaffSelect').value = data.prevSdStaffName || '';
                        document.getElementById('prevRcStaffSelect').value = data.prevRcStaffName || '';
                        document.getElementById('monthlyStandardHours').value = data.monthlyStandardHours || '176';
                        
                        document.getElementById('restShiftName').value = data.restShiftName || '休';

                        const loadedDates = JSON.parse(data.datesWithTypes || '[]');
                        window.datesWithTypes = loadedDates.map(item => ({
                            // FIX: 從 ISO 字串轉換回 Date 物件
                            dateObj: new Date(item.dateObj),
                            type: item.type
                        }));
                        window.renderSelectedDates();

                        const loadedRequirements = JSON.parse(data.requirements || '{}');
                        window.requirements = { 
                            Clinic_MWTH: loadedRequirements.Clinic_MWTH || {}, 
                            Clinic_TF: loadedRequirements.Clinic_TF || {}, 
                            Saturday: loadedRequirements.Saturday || {}, 
                            SundayHoliday: loadedRequirements.SundayHoliday || {}
                        };
                        window.drawShiftInputsFromRequirements();

                        window.preAssignedShifts = JSON.parse(data.preAssignedShifts || '{}');
                        
                        // 重新解析人員數據、更新 UI
                        window.parseStaffData();
                        window.renderPreAssignedShifts();
                        window.populateAllDropdowns(); // RENAME
                        
                        window.validateInputs();

                        console.log("Data loaded successfully.");
                        window.updateSaveStatus('資料已載入', 'success');
                    } else {
                        console.log("No saved data found. Using default values.");
                        window.updateSaveStatus('使用預設資料', 'info');
                        window.initDefaultData();
                    }
                } catch (e) {
                    console.error("Error loading document:", e);
                    window.updateSaveStatus('載入失敗', 'error');
                    window.initDefaultData();
                }
            };

            // --- 認證與初始化 ---
            window.initFirebase = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                    
                    window.userId = window.auth.currentUser?.uid || crypto.randomUUID();
                    console.log("Firebase initialized. User ID:", window.userId);

                    window.loadData();

                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    window.updateSaveStatus('認證失敗', 'error');
                }
            };

            window.initFirebase();
        }
    </script>
    
    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl font-bold text-primary mb-2">排班大師：自動平衡排休系統</h1>
            <p class="text-gray-600">遵守**領導固定班表**、**特殊輪班**及**勞基法約束**，一鍵生成平均休假分配的班表。</p>
            <div id="saveStatus" class="opacity-0"></div> <!-- 儲存狀態顯示區塊 -->
        </header>

        <main class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-100">

            <!-- 設定區塊 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">

                <!-- 日期與人員 -->
                <div class="col-span-1 lg:col-span-1 border-r lg:pr-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">1. 基礎資訊</h2>
                    <div class="space-y-4">
                        
                        <!-- 月份生成與日期選擇 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">1.1 一鍵生成月份班表</label>
                            <div class="flex space-x-2">
                                <input type="date" id="monthStartInput" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary focus:ring-secondary p-2.5 transition duration-150">
                                <button type="button" onclick="window.triggerMonthGeneration()" class="shrink-0 px-4 py-2 bg-pink-500 text-white font-semibold rounded-lg hover:bg-pink-600 transition duration-150 transform hover:scale-105">
                                    生成月份
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">選取月份中的任一天，將自動生成該月所有日期，並自動標記周六日。</p>
                        </div>
                        
                        <!-- 單日新增/連假日手動添加 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 mt-4 border-t pt-4">1.2 手動新增/連假日 (點選新增)</label>
                            
                            <div class="mb-2 grid grid-cols-2 gap-2 text-sm font-medium">
                                <label class="flex items-center">
                                    <input type="radio" name="dateType" value="Clinic_MWTH" class="text-secondary focus:ring-secondary" onchange="window.debounceSave()">
                                    <span class="ml-1.5 text-gray-700">門診日 (一三四)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="dateType" value="Clinic_TF" class="text-secondary focus:ring-secondary" onchange="window.debounceSave()">
                                    <span class="ml-1.5 text-gray-700">門診日 (二五)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="dateType" value="Saturday" class="text-secondary focus:ring-secondary" onchange="window.debounceSave()">
                                    <span class="ml-1.5 text-gray-700">禮拜六班</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="dateType" value="SundayHoliday" checked class="text-secondary focus:ring-secondary" onchange="window.debounceSave()">
                                    <span class="ml-1.5 text-gray-700">禮拜日/國定假</span>
                                </label>
                            </div>

                            <div class="flex space-x-2">
                                <input type="date" id="singleDateInput" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary focus:ring-secondary p-2.5 transition duration-150">
                                <button type="button" onclick="window.addDate()" class="shrink-0 px-4 py-2 bg-secondary text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 transform hover:scale-105">
                                    手動添加
                                </button>
                            </div>
                            
                            <div id="selectedDatesContainer" class="mt-3 space-y-2 max-h-40 overflow-y-auto p-2 rounded-md bg-gray-100 border border-gray-200">
                                <p class="text-gray-500 text-sm italic p-1 text-center">尚未選擇任何日期</p>
                            </div>
                        </div>

                        <!-- 人員名單 -->
                        <div>
                            <label for="staffNames" class="block text-sm font-medium text-gray-700">全體人員名單 (每行一位)</label>
                            <textarea id="staffNames" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary focus:ring-secondary p-2.5" oninput="window.debounceSave()" placeholder="張三&#10;李四&#10;王五&#10;趙六&#10;錢七">莉娟
麗雯
佩君
欣怡
婉霏
冠汝
文雄
芬萍
勇得
詣勛
丁丁
婷瑩
芷芸
惠琳
琦崴
俊穎
鈺珊
乙玲
宛淇</textarea>
                        </div>
                    </div>

                    <!-- 1.3 領導/特種輪班組別設定 (New Section) -->
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">1.3 班別分組與休假設定</h3>
                        <p class="text-sm text-red-500 font-medium mb-3">請將人員分組，未列入者視為**輪班人員**。</p>
                        
                        <div class="space-y-4">
                            <!-- 服務台/轉診中心 -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="serviceDeskStaffSelect" class="block text-xs font-medium text-gray-700 mb-1">服務台人員 (選擇一位)</label>
                                    <select id="serviceDeskStaffSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" onchange="window.debounceSave()">
                                        <option value="">(未選取)</option>
                                        <!-- populated by JS -->
                                    </select>
                                </div>
                                <div>
                                    <label for="referralCenterStaffSelect" class="block text-xs font-medium text-gray-700 mb-1">轉診中心人員 (選擇一位)</label>
                                    <select id="referralCenterStaffSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" onchange="window.debounceSave()">
                                        <option value="">(未選取)</option>
                                        <!-- populated by JS -->
                                    </select>
                                </div>
                            </div>
                            <!-- 正常班組 (1.4) -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="regStaff1Select" class="block text-xs font-medium text-gray-700 mb-1">1.4 正常班人員 (正1)</label>
                                    <select id="regStaff1Select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" onchange="window.debounceSave()">
                                        <option value="">(未選取)</option>
                                        <!-- populated by JS -->
                                    </select>
                                </div>
                                <div>
                                    <label for="regStaff2Select" class="block text-xs font-medium text-gray-700 mb-1">正常班人員 (正2)</label>
                                    <select id="regStaff2Select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" onchange="window.debounceSave()">
                                        <option value="">(未選取)</option>
                                        <!-- populated by JS -->
                                    </select>
                                </div>
                            </div>
                            
                            <!-- NEW: 上月輪班人員輸入 (1.6) -->
                            <div class="pt-4 border-t mt-4">
                                <h3 class="text-lg font-semibold text-gray-800 mb-2">1.6 上月輪班人員 (優先代理)</h3>
                                <p class="text-sm text-gray-500 mb-3">若本月固定人員休假，將優先排上月人員代理 F台/CO台/D1台。</p>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label for="prevSdStaffSelect" class="block text-xs font-medium text-gray-700 mb-1">上月服務台人員</label>
                                        <select id="prevSdStaffSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" onchange="window.debounceSave()">
                                            <option value="">(未選取)</option>
                                            <!-- populated by JS -->
                                        </select>
                                    </div>
                                    <div>
                                        <label for="prevRcStaffSelect" class="block text-xs font-medium text-gray-700 mb-1">上月轉診中心人員</label>
                                        <select id="prevRcStaffSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" onchange="window.debounceSave()">
                                            <option value="">(未選取)</option>
                                            <!-- populated by JS -->
                                        </select>
                                    </div>
                                </div>
                            </div>


                            <div>
                                <!-- UI 提示已更新 -->
                                <label for="rotationStartDate" class="block text-xs font-medium text-gray-700 mb-1">輪班起始日 (用於計算服務台/轉診中心及正常班輪替，建議設為當月 1 號)</label>
                                <input type="date" id="rotationStartDate" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary focus:ring-secondary p-2.5 transition duration-150" onchange="window.debounceSave()">
                            </div>
                            
                            <!-- NEW: Monthly Standard Hours Input -->
                            <div class="pt-4 border-t mt-4">
                                <label for="monthlyStandardHours" class="block text-xs font-medium text-gray-700 mb-1">每月計算基準工時 (小時)</label>
                                <input type="number" id="monthlyStandardHours" value="176" min="1" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-secondary focus:ring-secondary p-2.5 transition duration-150" oninput="window.debounceSave()">
                                <p class="text-xs text-gray-500 mt-1">此數值用於計算超額工時。例如：168 或 176 小時。</p>
                            </div>


                            <!-- NEW: 跨月輪班狀態輸入 -->
                            <div class="pt-4 border-t mt-4">
                                <h3 class="text-lg font-semibold text-gray-800 mb-2">1.5 跨月輪班狀態 (月頭約束檢查)</h3>
                                <p class="text-xs text-gray-500 mb-2">請設定上個月結束時的狀態：連續工作天數 (0-6) 和最後下班時間 (HHMM)。</p>
                                
                                <!-- 隱藏的輸入，用於儲存結構化的 carryOverStatusText (保持與 Firestore 兼容) -->
                                <textarea id="carryOverInput" rows="1" class="hidden"></textarea>

                                <div id="carryOverInputsContainer" class="space-y-2 max-h-48 overflow-y-auto p-2 bg-gray-100 rounded-md border border-gray-200">
                                    <p class="text-gray-500 text-sm italic p-1">請先在上方輸入人員名單。</p>
                                </div>
                            </div>
                            <!-- END NEW -->

                            <!-- NEW: 現有特休結餘 (用於平衡特休分配) -->
                            <div class="pt-4 border-t mt-4">
                                <h3 class="text-lg font-semibold text-gray-800 mb-2">1.7 現有特休結餘 (小時)</h3>
                                <p class="text-xs text-red-500 font-medium mb-2">⚠️ 將優先分配**休假**給**特休結餘較多者**。請輸入剩餘時數。</p>
                                <div class="bg-yellow-50 p-2 text-xs rounded-md mb-2 border border-yellow-200">
                                    <p class="font-semibold text-yellow-800">特休影響休息日調整級距 (Days):</p>
                                    <ul class="list-disc list-inside ml-2 text-yellow-700">
                                        <li>0-50 小時: +0.0 天 (休最少, 最低休息權重)</li>
                                        <li>50-100 小時: +0.5 天</li>
                                        <li>100-150 小時: +1.0 天</li>
                                        <li>150-200 小時: +1.5 天</li>
                                        <li>200+ 小時: +2.0 天 (休最多, 最高休息權重)</li>
                                    </ul>
                                </div>
                                <textarea id="annualLeaveBalanceText" rows="1" class="hidden"></textarea>
                                <div id="annualLeaveInputsContainer" class="space-y-2 max-h-48 overflow-y-auto p-2 bg-gray-100 rounded-md border border-gray-200">
                                    <p class="text-gray-500 text-sm italic p-1">請先在上方輸入人員名單。</p>
                                </div>
                            </div>
                            <!-- END NEW -->
                            
                            <!-- NEW: 現有結算時數 (用於平衡休假分配) -->
                            <div class="pt-4 border-t mt-4">
                                <h3 class="text-lg font-semibold text-gray-800 mb-2">1.8 現有結算時數 (小時)</h3>
                                <p class="text-xs text-gray-500 mb-2">將優先分配**休假**給**結算時數較高者**，請輸入員工的累計時數 (可為負值)。</p>
                                <textarea id="settlementHoursText" rows="1" class="hidden"></textarea>
                                <div id="settlementHoursInputsContainer" class="space-y-2 max-h-48 overflow-y-auto p-2 bg-gray-100 rounded-md border border-gray-200">
                                    <p class="text-gray-500 text-sm italic p-1">請先在上方輸入人員名單。</p>
                                </div>
                            </div>
                            <!-- END NEW -->


                        </div>
                        
                        <div class="mt-4 bg-blue-50 p-3 rounded-md border border-blue-200">
                            <h4 class="text-sm font-semibold text-blue-800 mb-1">領導組 (硬性固定班表):</h4>
                            <p class="text-xs text-blue-700">莉娟 (組長) / 麗雯 (副組長) / 佩君 (小組長)</p>
                        </div>
                    </div>
                </div>

                <!-- 班別與需求設定 - 已分拆成四部分 -->
                <div class="col-span-1 lg:col-span-2">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">2. 班別定義與每日需求</h2>
                    <div class="space-y-6">
                        <div>
                            <label for="restShiftName" class="block text-sm font-medium text-gray-700">休假班別名稱</label>
                            <input type="text" id="restShiftName" value="休" class="mt-1 block w-1/3 rounded-md border-gray-300 shadow-sm focus:border-secondary focus:ring-secondary p-2.5" required oninput="window.debounceSave()">
                        </div>

                        <!-- 2.1 全日門診日 (Mon/Wed/Thu) 班別需求 -->
                        <div class="border p-4 rounded-lg bg-white shadow-sm">
                            <h3 class="font-bold text-lg text-green-700 mb-3">2.1 全日門診日 (周一/三/四) 班別需求</h3>
                            <div class="flex items-center space-x-2 font-semibold text-gray-700 text-xs p-2 border-b">
                                <span class="w-1/4">班別名稱</span>
                                <span class="w-1/3">時段 (HH:MM-HH:MM)</span>
                                <span class="w-1/6 shrink-0">休息 (分)</span>
                                <span class="w-1/6 shrink-0">所需人數</span>
                                <span class="w-8 shrink-0"></span>
                            </div>
                            <div id="Clinic_MWTH_ShiftRequirementInputs" class="space-y-3 pt-3" oninput="window.debounceSave()">
                                <!-- 預設班別將由 JS 載入/初始化 -->
                            </div>
                            <button type="button" onclick="window.addShiftInput('Clinic_MWTH')" class="mt-3 text-sm px-3 py-1.5 border border-green-700 text-green-700 rounded-md hover:bg-green-700 hover:text-white transition duration-150 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                新增周一/三/四班別
                            </button>
                        </div>
                        
                        <!-- 2.2 全日門診日 (Tue/Fri) 班別需求 -->
                        <div class="border p-4 rounded-lg bg-white shadow-sm">
                            <h3 class="font-bold text-lg text-teal-700 mb-3">2.2 全日門診日 (周二/五) 班別需求</h3>
                            <div class="flex items-center space-x-2 font-semibold text-gray-700 text-xs p-2 border-b">
                                <span class="w-1/4">班別名稱</span>
                                <span class="w-1/3">時段 (HH:MM-HH:MM)</span>
                                <span class="w-1/6 shrink-0">休息 (分)</span>
                                <span class="w-1/6 shrink-0">所需人數</span>
                                <span class="w-8 shrink-0"></span>
                            </div>
                            <div id="Clinic_TF_ShiftRequirementInputs" class="space-y-3 pt-3" oninput="window.debounceSave()">
                                <!-- 預設班別將由 JS 載入/初始化 -->
                            </div>
                            <button type="button" onclick="window.addShiftInput('Clinic_TF')" class="mt-3 text-sm px-3 py-1.5 border border-teal-700 text-teal-700 rounded-md hover:bg-teal-700 hover:text-white transition duration-150 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                新增周二/五班別
                            </button>
                        </div>

                        <!-- 2.3 禮拜六班 班別需求 -->
                        <div class="border p-4 rounded-lg bg-white shadow-sm">
                            <h3 class="font-bold text-lg text-red-700 mb-3">2.3 禮拜六班 班別需求</h3>
                            <div class="flex items-center space-x-2 font-semibold text-gray-700 text-xs p-2 border-b">
                                <span class="w-1/4">班別名稱</span>
                                <span class="w-1/3">時段 (HH:MM-HH:MM)</span>
                                <span class="w-1/6 shrink-0">休息 (分)</span>
                                <span class="w-1/6 shrink-0">所需人數</span>
                                <span class="w-8 shrink-0"></span>
                            </div>
                            <div id="Saturday_ShiftRequirementInputs" class="space-y-3 pt-3" oninput="window.debounceSave()">
                                <!-- 預設班別將由 JS 載入/初始化 -->
                            </div>
                            <button type="button" onclick="window.addShiftInput('Saturday')" class="mt-3 text-sm px-3 py-1.5 border border-red-700 text-red-700 rounded-md hover:bg-red-700 hover:text-white transition duration-150 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                新增禮拜六班別
                            </button>
                        </div>
                        
                        <!-- 2.4 禮拜天 / 國定假日 班別需求 -->
                        <div class="border p-4 rounded-lg bg-white shadow-sm">
                            <h3 class="font-bold text-lg text-indigo-700 mb-3">2.4 禮拜天 / 國定假日 班別需求</h3>
                            <div class="flex items-center space-x-2 font-semibold text-gray-700 text-xs p-2 border-b">
                                <span class="w-1/4">班別名稱</span>
                                <span class="w-1/3">時段 (HH:MM-HH:MM)</span>
                                <span class="w-1/6 shrink-0">休息 (分)</span>
                                <span class="w-1/6 shrink-0">所需人數</span>
                                <span class="w-8 shrink-0"></span>
                            </div>
                            <div id="SundayHoliday_ShiftRequirementInputs" class="space-y-3 pt-3" oninput="window.debounceSave()">
                                <!-- 預設班別將由 JS 載入/初始化 -->
                            </div>
                            <button type="button" onclick="window.addShiftInput('SundayHoliday')" class="mt-3 text-sm px-3 py-1.5 border border-indigo-700 text-indigo-700 rounded-md hover:bg-indigo-700 hover:text-white transition duration-150 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                新增禮拜天/國定假班別
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 班別手動鎖定區塊 (MANUAL OVERRIDE ONLY) -->
            <div class="mt-8 p-6 bg-gray-50 rounded-xl border border-gray-200 shadow-inner">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b border-gray-300 pb-2">3. 班別鎖定與預選休假</h2>

                <!-- 3.1 預選休假/特休 - 移除九宮格，只留下方的手動鎖定 -->
                <div class="mb-6 border-b border-gray-300 pb-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">3.1 預班：手動鎖定休假或特休</h3>
                    <p class="text-xs text-gray-600 mb-3">請在下方選擇人員、日期，並輸入「休」、「特休」或「婚假」來鎖定假期。</p>
                </div>


                <!-- 3.2 手動鎖定工作班別 (已包含休假和特休鎖定) -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">人員</label>
                        <select id="manualStaff" class="w-full rounded-md border-gray-300 p-2 text-sm"></select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">日期</label>
                        <select id="manualDate" class="w-full rounded-md border-gray-300 p-2 text-sm"></select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">班別/假別 (選擇班別或假別)</label>
                        <!-- CHANGED: 替換為 SELECT 下拉選單 -->
                        <select id="manualShift" class="w-full rounded-md border-gray-300 p-2 text-sm" onchange="window.debounceSave()">
                            <option value="">-- 請選擇 --</option>
                            <!-- 由 JS 動態生成選項 -->
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="window.addManualShift()" class="w-full px-4 py-2 bg-primary text-white font-semibold rounded-lg shadow-md hover:bg-secondary transition duration-150 transform hover:scale-[1.02]">
                            鎖定班別/假別
                        </button>
                    </div>
                </div>

                <!-- 已鎖定班表清單與剩餘名額 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div id="preAssignedList" class="bg-gray-100 p-4 rounded-lg border border-gray-300 max-h-64 overflow-y-auto">
                        <p class="text-sm font-bold text-gray-700 border-b border-gray-300 pb-2 mb-2">已鎖定班表摘要：</p>
                        <ul class="mt-2 text-xs space-y-1 text-gray-700">
                            <li>無預先鎖定班表</li>
                        </ul>
                        <button onclick="window.clearPreAssignedShifts()" class="mt-3 text-red-600 text-xs hover:underline">解除所有鎖定</button>
                    </div>
                    
                    <div id="availabilityStatus" class="bg-gray-100 p-4 rounded-lg border border-gray-300 max-h-64 overflow-y-auto">
                        <p class="text-sm font-bold text-gray-800 mb-2 border-b border-gray-300 pb-2">工作班次剩餘名額 (已扣除鎖定班表)：</p>
                        <!-- 班次剩餘名額將顯示在這裡 -->
                        <p class="text-xs text-gray-500 italic">請先新增日期和定義班別需求。</p>
                    </div>
                </div>
            </div>
            
            <div id="validationMessage" class="text-red-500 font-medium text-sm mt-6 hidden rounded-md bg-red-50 p-3"></div>

            <div class="mt-6 flex justify-end space-x-3">
                <!-- 新增手動儲存按鈕 -->
                <button onclick="window.saveData && window.saveData()" class="w-full sm:w-auto px-6 py-3 border border-gray-400 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-100 transition duration-300 ease-in-out transform hover:scale-[1.02]">
                    手動儲存
                </button>
                <button onclick="window.generateSchedule()" class="w-full sm:w-auto px-8 py-3 bg-primary text-white font-semibold rounded-lg shadow-lg hover:bg-secondary transition duration-300 ease-in-out transform hover:scale-105">
                    一鍵生成平衡班表
                </button>
            </div>


            <!-- 結果區塊 -->
            <div id="scheduleOutput" class="mt-10 pt-6 border-t border-gray-200 hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">4. 生成班表結果</h2>

                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-3 sm:space-y-0 sm:space-x-4">
                    <div id="summaryStats" class="bg-gray-100 border border-gray-300 text-gray-800 p-4 rounded-lg w-full sm:w-auto flex-grow">
                        <!-- 統計數據將顯示在這裡 -->
                    </div>
                     <!-- 新增匯出按鈕 -->
                    <button onclick="window.exportToCSV()" class="shrink-0 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition duration-300 ease-in-out transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        匯出為 CSV
                    </button>
                </div>

                <div class="table-container shadow-lg rounded-lg border border-gray-200">
                    <table class="schedule-table w-full whitespace-nowrap bg-white divide-y divide-gray-200">
                        <thead id="scheduleHeader"></thead>
                        <tbody id="scheduleBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
                
                <!-- NEW BLOCK START: 班次總覽 (Section 4.1) -->
                <div id="shiftSummary" class="mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <p class="text-gray-500 italic">請先點擊「一鍵生成平衡班表」以計算總班次數量。</p>
                </div>
                <!-- NEW BLOCK END -->

                <!-- NEW SECTION 4.2: 小夜班次平衡總覽 -->
                <div id="lateShiftSummary" class="mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <p class="text-gray-500 italic">請先點擊「一鍵生成平衡班表」以顯示小夜班次統計。</p>
                </div>
                
                <!-- NEW SECTION 4.3: 週末及小夜班次明細 (從表格中分離出來) -->
                <div id="balanceBreakdownSummary" class="mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <p class="text-gray-500 italic">請先點擊「一鍵生成平衡班表」以顯示週末及小夜班次明細。</p>
                </div>


                <div class="mt-6">
                    <h3 class="lg font-semibold text-gray-700 mb-2">排班原則說明：</h3>
                    <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                        <li>**平衡目標 (UPDATED)：**
                            <ul>
                                <li>**N 班平均化及連續性 (最高優先級)：** **N 班分配將以「次數最少」的員工為最高優先級**。若次數相同，**將優先選擇昨日已排 N 班的員工**，以盡量連排。</li>
                                <li>**⛔️ 避免做一休一 (極高優先級)：** 系統將**強烈避免 (懲罰 5000)** 單日工作 (R-W-R) 或單日休息 (W-R-W) 的模式。排班將以連班或連休為優先。</li>
                                <!-- UPDATED TEXT HERE -->
                                <li>**週末休假平衡 (高優先級 - UPDATED)：** **周六/實際周日休假次數最少者** 優先獲得休假機會，目標為平均分配至 **2-3 次**。系統會**強制避免 (極高懲罰 50萬)** 單一週末休假次數達到 **4 次或以上**。</li>
                                <li>**小夜班次 (E▲/E△/E6) 平均化 (高優先級)：** **小夜班分配將以「次數最少」的輪班人員為高優先級**。</li>
                                <li>**S 班平均化 (次高優先級)：** **S 班（如 S2）分配將以「次數最少」的員工為次高優先級**。</li>
                                <li>**一般班次平均化 (高優先級)：** **所有工作班次的分配，將優先考慮該班次的累積次數最少者**，以確保像 W7/D1(5) 等班別也能平均。</li>
                                <li>**輪班人員工作/休假分配平衡：** <ul>
                                        <li>**休假分配 (高特休結餘優先 - NEW)：** **系統會根據特休結餘 (1.7 區塊) 調整休假權重。特休結餘越多 (權重越高)，獲得「休」假的優先權越高。**</li>
                                        <li>**休假分配 (高結算時數優先)：** **現有結算時數較高者** 優先休息。</li>
                                        <li>**工作分配 (低結餘優先)：** 系統將以**現有結算時數較少者優先工作**，以及**特休結餘較少者優先工作**作為排班的次要平衡目標。</li>
                                    </ul>
                                </li>
                                <li>**特休/婚假 (特休/婚假):** 特休和婚假只能透過手動鎖定功能預排。系統將依據您在 1.7 欄位輸入的特休結餘，自動扣除預排的特休天數。</li>
                            </ul>
                        </li>
                        <li>**休假覆蓋需求：** **(莉娟/麗雯 免補償)** 當 佩君、服務台、轉診中心、正常班組人員休假或特休時，其原本的工作班次需求會自動增加 1 (由輪班人員代理補齊)。</li>
                        <li>**班別強制覆蓋 (MUST)：** **所有定義的工作班別都必須至少分配到一位人員** (由輪班人員補足，如果固定組未佔用該班別)。</li>
                        <li>**上月代理優先：** **如果服務台或轉診中心人員休假，且因此觸發需求補償，系統將優先從 [上月服務台/轉診中心人員] 中選擇代理人。**</li>
                        <li>**領導與特種班表優先 (UPDATED)：** **領導組 (莉娟/麗雯) 的班表將被強制鎖定 (除非手動設定休/特休/婚假)。佩君、服務台、轉診中心、正常班組人員的手動鎖定將完全覆蓋系統的輪替邏輯。**</li>
                        <li>**休假平均化：** 系統將盡力平均 **總休假、周六休假、實際周日休假** (在新的平衡目標之後)。</li>
                        <li>**連續工作約束：** 強制確保員工不會連續工作超過 6 天。</li>
                        <li>**連續休假約束：** **休假不能連續超過 3 天。**</li>
                        <li>**N 班約束：** N 班分配絕對不能接在 D1台、I3 或 D1(5) 班次之後，且必須遵守 11 小時休息間隔。</li>
                        <li>**勞基法約束：** 排班強制遵守 11 小時休息間隔 (月頭檢查依賴於**跨月輪班狀態**輸入)。</li>
                        <li>**每日休假人數計算 (UPDATE)：** 僅計算「**休**」和半天班次（0.5 人）的總和。「**特休**」和「**婚假**」不計入此人數，以反映實際需補足的人力空缺。</li>
                    </ul>
                </div>

            </div>

        </main>
    </div>

    <!-- NEW: 班別明細彈出視窗 (Modal) -->
    <div id="shiftModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex justify-center items-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white p-6 border-b border-gray-200 flex justify-between items-center z-10">
                <h3 id="modalTitle" class="text-xl font-bold text-primary">班別分配明細</h3>
                <button onclick="window.closeModal()" class="text-gray-500 hover:text-gray-900 transition duration-150 p-2 rounded-full hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="modalContent" class="p-0">
                <!-- 明細列表將載入在這裡 -->
            </div>
        </div>
    </div>


    <script>
        // 全域變量
        let staffList = [];
        let staffDataMap = {}; // {name: {group: '...'}, ...}
        const LEADER_NAMES = ['莉娟', '麗雯', '佩君']; // 更新領導名稱
        const ANNUAL_LEAVE_SHIFT = '特休'; // 新增特休班別名稱
        const WEDDING_LEAVE_SHIFT = '婚假'; // NEW: 新增婚假班別名稱
        // 修正 GROUP_ORDER 順序，將服務台/轉診中心放在輪班人員後面 (最底部)
        const GROUP_ORDER = ['領導組', '正常班組', '輪班人員', '服務台組', '轉診中心組']; // NEW: 增加正常班組
        const HALF_DAY_SHIFTS = ['D1台', 'W7', 'Y7', 'D1(5)']; // NEW: 半天班次列表
        const LATE_SHIFTS = ['E▲', 'E△', 'E6']; // NEW: 小夜的定義

        // NEW: 特休平衡單位 (1 天特休 = 8 小時)
        const HOURS_PER_ANNUAL_LEAVE_DAY = 8;

        let datesWithTypes = [];
        let requirements = { Clinic_MWTH: {}, Clinic_TF: {}, Saturday: {}, SundayHoliday: {} }; 
        let restShiftName = '休';
        let preAssignedShifts = {}; // { staffName: { 'YYYY-MM-DD': shiftName }, ... }
        
        let saveTimer;
        let staffStats = {}; 

        const TOTAL_MINUTES_IN_DAY = 1440;
        const MIN_REST_MINUTES = 660; // 11 hours * 60
        const MAX_CONSECUTIVE_WORK_DAYS = 6; // 連續工作天數上限
        const MAX_CONSECUTIVE_REST_DAYS = 3; // 新增約束: 休假不能連續超過 3 天
        const MS_PER_DAY = 24 * 60 * 60 * 1000;
        
        // NEW: 正常班組的次要班次列表 (根據日期類型動態決定)
        const REGULAR_STAFF_SECONDARY_SHIFTS = {
            Clinic_MWTH: ['D△', 'D6', 'D7', 'D1(5)'], // UPDATED: D15 -> D1(5)
            Clinic_TF: ['D△', 'D6', 'D7', 'CO5'] 
        };
        
        // SD/RC 相關班次名稱，用於代理優先級判斷
        const SD_RC_PROXY_SHIFTS = ['F台', 'CO台', 'D1台'];


        /**
         * Safely converts YYYY-MM-DD string to a Date object representing the start of that day in LOCAL TIME.
         * This prevents timezone rollbacks (e.g., 2025-12-05 becoming 2025-12-04 16:00:00 GMT in UTC+8).
         * @param {string} isoKey YYYY-MM-DD
         * @returns {Date | null}
         */
        function safeDateFromISO(isoKey) {
            if (!isoKey || isoKey.length !== 10) return null;
            const [year, month, day] = isoKey.split('-').map(Number);
            // Use local time components to create the Date object, preventing UTC midnight rollback.
            // Note: Month index is 0-based in JS Date, so we subtract 1 from month.
            return new Date(year, month - 1, day, 0, 0, 0, 0);
        }

        /**
         * 延遲儲存函數 (Debounce Save)
         */
        window.debounceSave = () => {
            if (saveTimer) {
                clearTimeout(saveTimer);
            }
            saveTimer = setTimeout(() => {
                window.parseStaffData(); // 重新解析人員數據和分組
                window.populateAllDropdowns(); // RENAME
                window.populateShiftDatalist();
                window.validateInputs(); 
                window.renderShiftAvailability();
                if (window.saveData) {
                    window.saveData(); 
                }
            }, 800);
        }
        
        /**
         * 解析 staffNames, group inputs，建立 staffDataMap 和 staffList。
         */
        window.parseStaffData = () => {
            const allNames = document.getElementById('staffNames').value.trim().split('\n').map(name => name.trim()).filter(name => name.length > 0);
            
            // 變更: 取得單一選擇的值
            const sdName = document.getElementById('serviceDeskStaffSelect').value;
            const rcName = document.getElementById('referralCenterStaffSelect').value;
            const regStaff1Name = document.getElementById('regStaff1Select').value;
            const regStaff2Name = document.getElementById('regStaff2Select').value;
            
            // 變更: 確保只有選取的單一名稱在列表中
            const sdNames = sdName ? [sdName] : [];
            const rcNames = rcName ? [rcName] : [];
            const regStaffNames = [regStaff1Name, regStaff2Name].filter(name => name);

            staffList = allNames;
            staffDataMap = {};

            // 1. 建立 Staff Data Map
            allNames.forEach(name => {
                let group = '輪班人員';
                if (LEADER_NAMES.includes(name)) {
                    group = '領導組';
                } else if (sdNames.includes(name)) {
                    group = '服務台組';
                } else if (rcNames.includes(name)) { // This assigns the group if selected
                    group = '轉診中心組';
                } else if (regStaffNames.includes(name)) { 
                    group = '正常班組';
                }
                staffDataMap[name] = { group: group };
            });

            // 3. 過濾並更新 staffList (確保順序和唯一性)
            staffList = allNames.filter(name => staffDataMap[name]);

            // NEW: 每次人員列表變更時，重新渲染動態輸入欄位 (包括結餘和時數)
            window.renderCarryOverInputs(); 
            window.renderAnnualLeaveInputs();
            window.renderSettlementHoursInputs();

        }; 

        // --- 時間解析與勞基法約束函數 ---
        /**
         * 將 HH:MM-HH:MM 格式轉換為分鐘數。
         * @param {string} timeSlot - e.g., '08:00-16:00' or '22:00-06:00'
         * @returns {{startMin: number, endMin: number} | null}
         */
        function parseShiftTime(timeSlot) {
            const timeRegex = /^(\d{2}:\d{2})-(\d{2}:\d{2})$/;
            const match = timeSlot.match(timeRegex);
            if (!match) return null;

            const [_, startStr, endStr] = match;
            const [startH, startM] = startStr.split(':').map(Number);
            const [endH, endM] = endStr.split(':').map(Number);

            if (isNaN(startH) || isNaN(startM) || isNaN(endH) || isNaN(endM) ||
                startH > 23 || endH > 23 || startM > 59 || endM > 59) {
                return null;
            }

            let startMin = startH * 60 + startM;
            let endMin = endH * 60 + endM;

            // 核心修正點：只有當結束時間 <= 開始時間 且 開始時間不是 00:00 (即非N班) 時，才視為跨日
            if (endMin <= startMin && startMin !== 0) {
                endMin += TOTAL_MINUTES_IN_DAY;
            }
            // 針對 00:00 開始的 N 班，它是在當天結束的，所以不加 1440

            return { startMin, endMin };
        }
        
        /**
         * 獲取班次工時 (分鐘)，特休固定為 8 小時 (480 分鐘)。
         * UPDATED: 需扣除休息時間。
         * @param {string} shiftName - 班次名稱 (可能是多班次字串)
         * @param {string} dateType - 日期類型 (Clinic_MWTH, Saturday, etc.)
         * @returns {number} 淨工作總工時 (分鐘)
         */
        function getShiftDuration(shiftName, dateType) {
            if (shiftName === restShiftName || !shiftName) {
                return 0;
            }
            
            // 特休/婚假 固定 8 小時 = 480 分鐘
            if (shiftName === ANNUAL_LEAVE_SHIFT || shiftName === WEDDING_LEAVE_SHIFT) {
                return 8 * 60; // 480 minutes
            }

            const shifts = shiftName.split(',').map(s => s.trim()).filter(s => s !== restShiftName);
            let totalNetMinutes = 0; // 淨工作分鐘數

            shifts.forEach(shift => {
                // 1. Try to find the shift definition in the specific dateType (most accurate)
                let shiftInfo = requirements[dateType]?.[shift];

                // 2. If not found, search across all defined types (for cross-day/shared shifts like N, CO)
                if (!shiftInfo) {
                    for (const typeKey in requirements) {
                        if (requirements[typeKey][shift] && typeKey !== dateType) {
                            shiftInfo = requirements[typeKey][shift];
                            // Break after finding the first definition (assuming consistent definition)
                            break;
                        }
                    }
                }

                if (shiftInfo && shiftInfo.timeSlot) {
                    // ** FIX: Use parsed timeMeta from getShiftTime for accurate duration **
                    const timeMeta = parseShiftTime(shiftInfo.timeSlot);
                    if (timeMeta) {
                        const grossDuration = timeMeta.endMin - timeMeta.startMin;
                        // NEW: Retrieve and use resting minutes
                        const restingMinutes = shiftInfo.restingMinutes || 0; 
                        
                        const netDuration = Math.max(0, grossDuration - restingMinutes); // Ensure duration is not negative
                        totalNetMinutes += netDuration;
                    }
                }
            });

            return totalNetMinutes; // Return net work minutes
        }

        /**
         * 檢查員工是否可以被分配到某個班別 (勞基法 11 小時休息間隔)。
         */
        function checkEightHourRule(lastEndMin, currentShiftTimeMeta) {
            if (lastEndMin === 0 || !currentShiftTimeMeta) {
                return true;
            }
            
            const currentStartMin = currentShiftTimeMeta.startMin;
            // lastEndMin is relative to the midnight of the previous day (Day T-1)
            let restDuration = currentStartMin + (TOTAL_MINUTES_IN_DAY - lastEndMin);
            
            // ** FIX: 針對 N 班 (00:00 開始) 的特殊處理 **
            // 如果前一班不是 N 班，且當前班次開始時間早於前一班的結束時間 (lastEndMin)，則 lastEndMin 應視為 "前一天" 的結束時間。
            if (lastEndMin > TOTAL_MINUTES_IN_DAY) { // 前一班是跨日班 (例如 15:30-00:00)
                // lastEndMin 已經是 1440 + 結束分鐘
                restDuration = currentStartMin + (TOTAL_MINUTES_IN_DAY - (lastEndMin % TOTAL_MINUTES_IN_DAY));
            } else if (lastEndMin > 0) { // 前一班是日班或 N 班 (結束時間 < 1440)
                 restDuration = currentStartMin + (TOTAL_MINUTES_IN_DAY - lastEndMin);
            }
            
            return restDuration >= MIN_REST_MINUTES;
        }
        
        /**
         * 根據 YYYY-MM-DD 鍵獲取對應的 DateObj
         * @param {string} isoKey YYYY-MM-DD
         * @returns {Date | null}
         */
        function getDateObjFromISOKey(isoKey) {
            // FIX: 修正作用域錯誤，改用 dateItem 變數。
            const dateItem = datesWithTypes.find(d => d.dateObj.toISOString().split('T')[0] === isoKey);
            // 修正錯誤：將 item.dateObj 替換為 dateItem.dateObj
            return dateItem ? dateItem.dateObj : null; 
        }
        
        /**
         * NEW: 根據特休結餘 (小時) 計算休息日調整因子 (Days)。
         * @param {number} annualLeaveHours - 特休結餘時數 (Hours)
         * @returns {number} 休息調整天數 (0.0, 0.5, 1.0, 1.5, 2.0)
         */
        function calculateALRestAdjustment(annualLeaveHours) {
            // UPDATED LOGIC: Higher hours mean higher adjustment value (higher rest preference)
            if (annualLeaveHours >= 200) {
                return 2.0; // 200+ hours: +2.0 days adjustment (休最多, 最高休息優先權)
            } else if (annualLeaveHours >= 150) {
                return 1.5; // 150-200 hours: +1.5 days adjustment
            } else if (annualLeaveHours >= 100) {
                return 1.0; // 100-150 hours: +1.0 day adjustment
            } else if (annualLeaveHours >= 50) {
                return 0.5; // 50-100 hours: +0.5 days adjustment
            } else {
                return 0.0; // 0-50 hours: +0.0 days adjustment (休最少, 最低休息優先權)
            }
        }

        // --- NEW: 解析跨月狀態函數 ---
        /**
         * 解析跨月狀態文字輸入。
         * @returns {Object<string, {consecutiveWorkDays: number, lastEndMin: number}>}
         */
        function parseCarryOverStatus() {
            const input = document.getElementById('carryOverInput').value.trim(); // Reads the hidden field content
            const statusMap = {};
            const lines = input.split('\n').filter(line => line.trim() !== '');

            lines.forEach(line => {
                // 格式: 姓名: 數字, HHMM
                const match = line.match(/^(.+?):\s*(\d+),\s*(\d{4})$/);
                if (match) {
                    const name = match[1].trim();
                    const days = parseInt(match[2], 10);
                    const timeStr = match[3];
                    
                    const hours = parseInt(timeStr.substring(0, 2), 10);
                    const minutes = parseInt(timeStr.substring(2, 4), 10);
                    
                    if (days >= 0 && days <= 6 && hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
                        
                        let endMin = hours * 60 + minutes;
                        
                        // 處理跨日班次: 假定任何在 00:00 到 08:00 之間結束的班次都是前一天開始的夜班
                        if (hours < 8) { 
                            endMin += TOTAL_MINUTES_IN_DAY; 
                        }
                        // 針對 08:30 結束的 N 班，它是在當天結束的，所以不加 1440
                        if (hours === 8 && minutes === 30 && endMin > TOTAL_MINUTES_IN_DAY) {
                             endMin = 8 * 60 + 30; // 510 分鐘，不加 1440
                        }


                        statusMap[name] = {
                            consecutiveWorkDays: days,
                            lastEndMin: endMin
                        };
                    }
                }
            });
            return statusMap;
        }
        
        /**
         * NEW: 解析員工結餘（特休和結算時數）。
         * @returns {Object<string, {annualLeaveDays: number, settlementHours: number}>}
         */
        function parseStaffBalances() {
            const alInput = document.getElementById('annualLeaveBalanceText').value.trim();
            const shInput = document.getElementById('settlementHoursText').value.trim();
            const balanceMap = {};

            // Helper to parse line data
            const parseLines = (input, key) => {
                const lines = input.split('\n').filter(line => line.trim() !== '');
                lines.forEach(line => {
                    // 格式: 姓名: 數字
                    const match = line.match(/^(.+?):\s*([-\d.]+)$/);
                    if (match) {
                        const name = match[1].trim();
                        const value = parseFloat(match[2]);
                        if (!balanceMap[name]) {
                            balanceMap[name] = { annualLeaveDays: 0, settlementHours: 0 };
                        }

                        if (key === 'annualLeaveDays') {
                            // NEW LOGIC: Convert input Hours (value) to internal Days (value / 8)
                            balanceMap[name][key] = value / HOURS_PER_ANNUAL_LEAVE_DAY;
                        } else {
                            // settlementHours is already in hours
                            balanceMap[name][key] = value;
                        }
                    }
                });
            };

            parseLines(alInput, 'annualLeaveDays');
            parseLines(shInput, 'settlementHours');

            return balanceMap;
        }
        
        // --- NEW: 根據輸入更新隱藏的 carryOverInput 欄位 ---
        function updateCarryOverTextFromInputs(triggerSave = true) {
            const container = document.getElementById('carryOverInputsContainer');
            if (!container) return;

            let statusLines = [];
            staffList.forEach(name => {
                const daysInput = document.getElementById(`carryover-days-${name}`);
                const timeInput = document.getElementById(`carryover-time-${name}`);
                
                if (daysInput && timeInput) {
                    const days = parseInt(daysInput.value, 10);
                    const timeStr = timeInput.value.replace(':', '').padStart(4, '0'); 
                    
                    // 只有當天數 > 0 或時間不是預設值 (08:00) 時才記錄，以保持精簡
                    if (days > 0 || timeInput.value !== '08:00') {
                        statusLines.push(`${name}: ${days}, ${timeStr}`);
                    }
                }
            });
            
            document.getElementById('carryOverInput').value = statusLines.join('\n');
            if(triggerSave) {
                window.debounceSave(); // Trigger debounce save after updating the hidden text
            }
        }
        
        // --- NEW: 根據輸入更新隱藏的 AnnualLeaveBalanceText 欄位 ---
        function updateAnnualLeaveTextFromInputs(triggerSave = true) {
            const container = document.getElementById('annualLeaveInputsContainer');
            if (!container) return;

            let statusLines = [];
            staffList.forEach(name => {
                const input = document.getElementById(`al-balance-${name}`);
                if (input) {
                    // Check if value is non-zero, non-empty, and valid number
                    const value = parseFloat(input.value);
                    if (value !== 0 && !isNaN(value)) {
                        // NEW: Store input value (Hours) directly in the hidden text field
                        statusLines.push(`${name}: ${value}`);
                    }
                }
            });
            document.getElementById('annualLeaveBalanceText').value = statusLines.join('\n');
            if(triggerSave) {
                window.debounceSave();
            }
        }

        // --- NEW: 根據輸入更新隱藏的 SettlementHoursText 欄位 ---
        function updateSettlementHoursTextFromInputs(triggerSave = true) {
            const container = document.getElementById('settlementHoursInputsContainer');
            if (!container) return;

            let statusLines = [];
            staffList.forEach(name => {
                const input = document.getElementById(`sh-balance-${name}`);
                if (input) {
                    // Check if value is non-zero, non-empty, and valid number
                    const value = parseFloat(input.value);
                    if (value !== 0 && !isNaN(value)) {
                        statusLines.push(`${name}: ${value}`);
                    }
                }
            });
            document.getElementById('settlementHoursText').value = statusLines.join('\n');
            if(triggerSave) {
                window.debounceSave();
            }
        }
        
        // --- NEW: 渲染動態的跨月狀態輸入 ---
        window.renderCarryOverInputs = () => {
            const container = document.getElementById('carryOverInputsContainer');
            if (!container) return;

            const currentStatusMap = parseCarryOverStatus();
            
            container.innerHTML = '';
            
            if (staffList.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm italic p-1">請先在上方輸入人員名單。</p>';
                return;
            }

            staffList.forEach(name => {
                const status = currentStatusMap[name] || { consecutiveWorkDays: 0, lastEndMin: 0 };
                const defaultDays = status.consecutiveWorkDays || 0;
                
                // 處理 lastEndMin 的顯示格式
                let defaultTime;
                let lastEndMin = status.lastEndMin || 0;

                // 如果 lastEndMin 為 0，則顯示預設的 08:00
                if (lastEndMin === 0) {
                    defaultTime = '08:00';
                } else if (lastEndMin > TOTAL_MINUTES_IN_DAY) {
                    // 跨日班次
                    const mins = lastEndMin % TOTAL_MINUTES_IN_DAY;
                    const hours = Math.floor(mins / 60);
                    const minutes = mins % 60;
                    defaultTime = hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0');
                } else {
                    // 日班或 N 班
                    const hours = Math.floor(lastEndMin / 60);
                    const minutes = lastEndMin % 60;
                    defaultTime = hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0');
                }

                const timeFormatted = defaultTime;

                let daysOptions = '';
                for (let i = 0; i <= MAX_CONSECUTIVE_WORK_DAYS; i++) {
                    daysOptions += `<option value="${i}" ${i === defaultDays ? 'selected' : ''}>${i} 天</option>`;
                }

                const staffRow = document.createElement('div');
                staffRow.className = 'flex items-center space-x-2 text-xs border-b border-gray-200 py-1';
                staffRow.innerHTML = `
                    <span class="font-semibold text-gray-800 w-1/4 truncate">${name}</span>
                    <div class="w-1/4">
                        <select id="carryover-days-${name}" class="w-full rounded-md border-gray-300 p-1 text-xs bg-white" onchange="updateCarryOverTextFromInputs()">
                            ${daysOptions}
                        </select>
                    </div>
                    <div class="w-1/2 flex items-center space-x-1">
                        <input type="text" id="carryover-time-${name}" value="${timeFormatted}" 
                            class="w-full rounded-md border-gray-300 p-1 text-xs bg-white font-mono" 
                            placeholder="HH:MM" pattern="([01]?[0-9]|2[0-3]):[0-5][0-9]" maxlength="5"
                            onchange="updateCarryOverTextFromInputs()">
                        <span class="text-gray-500 text-xs">下班</span>
                    </div>
                `;
                container.appendChild(staffRow);
            });
        };
        // --- END NEW RENDER (Carry Over) ---

        // --- NEW: 渲染動態的 Annual Leave Inputs ---
        window.renderAnnualLeaveInputs = () => {
            const container = document.getElementById('annualLeaveInputsContainer');
            if (!container) return;

            const balances = parseStaffBalances();
            container.innerHTML = '';

            if (staffList.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm italic p-1">請先在上方輸入人員名單。</p>';
                return;
            }

            staffList.forEach(name => {
                // NEW: Calculate default hours for display: Stored Days * 8
                const defaultHours = (balances[name]?.annualLeaveDays || 0) * HOURS_PER_ANNUAL_LEAVE_DAY;
                const staffRow = document.createElement('div');
                staffRow.className = 'flex items-center space-x-2 text-xs border-b border-gray-200 py-1';
                staffRow.innerHTML = `
                    <span class="font-semibold text-gray-800 w-1/3 truncate">${name}</span>
                    <div class="w-2/3 flex items-center space-x-1">
                        <input type="number" step="${HOURS_PER_ANNUAL_LEAVE_DAY / 2}" id="al-balance-${name}" value="${defaultHours.toFixed(1)}"
                            class="w-full rounded-md border-gray-300 p-1 text-xs bg-white font-mono"
                            placeholder="時數" oninput="updateAnnualLeaveTextFromInputs()">
                        <span class="text-gray-500 text-xs">小時</span>
                    </div>
                `;
                container.appendChild(staffRow);
            });
        };
        // --- END NEW RENDER (Annual Leave) ---

        // --- NEW: 渲染動態的 Settlement Hours Inputs ---
        window.renderSettlementHoursInputs = () => {
            const container = document.getElementById('settlementHoursInputsContainer');
            if (!container) return;

            const balances = parseStaffBalances();
            container.innerHTML = '';

            if (staffList.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm italic p-1">請先在上方輸入人員名單。</p>';
                return;
            }

            staffList.forEach(name => {
                const defaultHours = balances[name]?.settlementHours || 0;
                const staffRow = document.createElement('div');
                staffRow.className = 'flex items-center space-x-2 text-xs border-b border-gray-200 py-1';
                staffRow.innerHTML = `
                    <span class="font-semibold text-gray-800 w-1/3 truncate">${name}</span>
                    <div class="w-2/3 flex items-center space-x-1">
                        <input type="number" step="0.5" id="sh-balance-${name}" value="${defaultHours.toFixed(1)}"
                            class="w-full rounded-md border-gray-300 p-1 text-xs bg-white font-mono"
                            placeholder="時數" oninput="updateSettlementHoursTextFromInputs()">
                        <span class="text-gray-500 text-xs">小時</span>
                    </div>
                `;
                container.appendChild(staffRow);
            });
        };
        // --- END NEW RENDER (Settlement Hours) ---


        // --- UI/Data Synchronization Functions ---
        window.updateRequirementsFromInputs = () => {
            requirements = { Clinic_MWTH: {}, Clinic_TF: {}, Saturday: {}, SundayHoliday: {} };
            restShiftName = document.getElementById('restShiftName').value.trim() || '休';

            ['Clinic_MWTH', 'Clinic_TF', 'Saturday', 'SundayHoliday'].forEach(type => {
                const shiftInputs = document.querySelectorAll(`#${type}_ShiftRequirementInputs > div`);
                
                shiftInputs.forEach(div => {
                    const nameInput = div.querySelector('.shift-name-input');
                    const timeInput = div.querySelector('.shift-time-input'); 
                    const restingInput = div.querySelector('.shift-resting-input'); // NEW: Get resting input
                    const countInput = div.querySelector('.shift-count-input');
                    
                    const shiftName = nameInput.value.trim();
                    const shiftTime = timeInput.value.trim(); 
                    const shiftCount = parseInt(countInput.value, 10);
                    const restingMinutes = parseInt(restingInput.value, 10) || 0; // NEW: Get value

                    if (shiftName && shiftCount >= 0) {
                        const timeMeta = parseShiftTime(shiftTime);
                        requirements[type][shiftName] = { 
                            count: shiftCount, 
                            timeSlot: shiftTime,
                            restingMinutes: restingMinutes, // NEW: Store resting minutes
                            timeMeta: timeMeta 
                        };
                    }
                });
                
                // 確保休假班別存在於 requirements 中 (休, 特休, 婚假)
                requirements[type][restShiftName] = { 
                    count: 0,
                    timeSlot: 'N/A',
                    restingMinutes: 0, // NEW: Default 0
                    timeMeta: null 
                }; 
                requirements[type][ANNUAL_LEAVE_SHIFT] = { 
                    count: 0,
                    timeSlot: 'N/A',
                    restingMinutes: 0, // NEW: Default 0
                    timeMeta: null 
                }; 
                // NEW: Add Wedding Leave to requirements
                requirements[type][WEDDING_LEAVE_SHIFT] = { 
                    count: 0,
                    timeSlot: 'N/A',
                    restingMinutes: 0, 
                    timeMeta: null 
                }; 
            });
            window.populateShiftDatalist();
        };

        window.drawShiftInputsFromRequirements = () => {
            ['Clinic_MWTH', 'Clinic_TF', 'Saturday', 'SundayHoliday'].forEach(type => {
                const container = document.getElementById(type + '_ShiftRequirementInputs');
                if (!container) return;
                container.innerHTML = '';
                
                const shifts = requirements[type];
                
                // 排除休假、特休和婚假
                Object.keys(shifts).filter(name => name !== restShiftName && name !== ANNUAL_LEAVE_SHIFT && name !== WEDDING_LEAVE_SHIFT).forEach(shiftName => {
                    const shift = shifts[shiftName];
                    const newDiv = document.createElement('div');
                    newDiv.className = 'flex items-center space-x-2';
                    
                    const buttonHtml = `<button type="button" onclick="window.removeShiftInput(this)" data-type="${type}" class="shrink-0 text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition duration-150 w-8">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm6 3a1 1 0 100 2h-4a1 1 0 100-2h4z" clip-rule="evenodd" />
                                            </svg>
                                            </button>`;

                    const nameInputHtml = `<input type="text" value="${shiftName}" class="shift-name-input w-1/4 rounded-md border-gray-300 p-2" placeholder="班別名稱" oninput="window.debounceSave()">`;
                    const timeInputHtml = `<input type="text" value="${shift.timeSlot || ''}" class="shift-time-input w-1/3 rounded-md border-gray-300 p-2" placeholder="時段 (HH:MM-HH:MM)" oninput="window.debounceSave()">`;
                    const restingInputHtml = `<input type="number" value="${shift.restingMinutes || 0}" min="0" class="shift-resting-input w-1/6 shrink-0 rounded-md border-gray-300 p-2" placeholder="休息" oninput="window.debounceSave()">`; // NEW HTML
                    const countInputHtml = `<input type="number" value="${shift.count}" min="0" class="shift-count-input w-1/6 shrink-0 rounded-md border-gray-300 p-2" placeholder="所需人數" oninput="window.debounceSave()">`; // Adjusted width

                    newDiv.innerHTML = `
                        ${nameInputHtml}
                        ${timeInputHtml}
                        ${restingInputHtml}
                        ${countInputHtml}
                        ${buttonHtml}
                        `;
                    container.appendChild(newDiv);
                });
            });
        };

        window.addShiftInput = (type) => {
            const container = document.getElementById(type + '_ShiftRequirementInputs');
            if (!container) return;
            const newDiv = document.createElement('div');
            newDiv.className = 'flex items-center space-x-2';
            
            let defaultName = '新班';
            let defaultTime = '08:00-16:00';
            let defaultResting = 30; // Default resting time for new shift button
            
            if (type === 'Clinic_MWTH') { defaultName = '新班_一三四'; defaultTime = '08:00-16:30'; defaultResting = 30; } 
            else if (type === 'Clinic_TF') { defaultName = '新班_二五'; defaultTime = '08:00-16:30'; defaultResting = 30; } 
            else if (type === 'SundayHoliday') { defaultName = '新班_假日'; defaultTime = '08:00-16:00'; defaultResting = 30; } 
            else if (type === 'Saturday') { defaultName = '新班_週六'; defaultTime = '08:00-14:00'; defaultResting = 30; }


            newDiv.innerHTML = `
                <input type="text" value="${defaultName}" class="shift-name-input w-1/4 rounded-md border-gray-300 p-2" placeholder="班別名稱" oninput="window.debounceSave()">
                <input type="text" value="${defaultTime}" class="shift-time-input w-1/3 rounded-md border-gray-300 p-2" placeholder="時段 (HH:MM-HH:MM)" oninput="window.debounceSave()">
                <input type="number" value="${defaultResting}" min="0" class="shift-resting-input w-1/6 shrink-0 rounded-md border-gray-300 p-2" placeholder="休息" oninput="window.debounceSave()">
                <input type="number" value="1" min="0" class="shift-count-input w-1/6 shrink-0 rounded-md border-gray-300 p-2" placeholder="所需人數" oninput="window.debounceSave()">
                <button type="button" onclick="window.removeShiftInput(this)" data-type="${type}" class="shrink-0 text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition duration-150 w-8">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm6 3a1 1 0 100 2h-4a1 1 0 100-2h4z" clip-rule="evenodd" />
                </svg>
                </button>
            `;
            container.appendChild(newDiv);
            window.debounceSave();
        };

        window.removeShiftInput = (button) => {
            button.closest('.flex').remove();
            window.debounceSave();
        };

        window.addDate = () => {
            const input = document.getElementById('singleDateInput');
            const dateStr = input.value;
            const dateType = document.querySelector('input[name="dateType"]:checked').value;
            if (!dateStr) return;
            
            // FIX: 使用 safeDateFromISO 確保時區正確
            const newDateObj = safeDateFromISO(dateStr);
            if (isNaN(newDateObj.getTime())) { window.showMessage('❌ 無效的日期格式。', 'error'); return; }
            const newDateKey = newDateObj.toISOString().split('T')[0];
            const existingIndex = datesWithTypes.findIndex(d => d.dateObj.toISOString().split('T')[0] === newDateKey);

            if (existingIndex !== -1) {
                datesWithTypes[existingIndex].type = dateType;
                window.showMessage(`ℹ️ 日期 ${window.formatDate(newDateObj)} 已更新為 ${window.getTypeLabel(dateType)}。`, 'info');
            } else {
                datesWithTypes.push({ dateObj: newDateObj, type: dateType });
                window.showMessage(`✅ 日期 ${window.formatDate(newDateObj)} 已添加。`, 'success');
            }
            datesWithTypes.sort((a, b) => a.dateObj.getTime() - b.dateObj.getTime());
            // preAssignedShifts = {}; // Do not clear preAssignedShifts on date change, only render/re-evaluate
            window.renderPreAssignedShifts();
            window.renderSelectedDates();
            window.populateAllDropdowns(); // RENAME
            window.validateInputs(); 
            window.saveData && window.saveData();
        };

        window.removeDate = (dateKey) => {
            datesWithTypes = datesWithTypes.filter(date => date.dateObj.toISOString().split('T')[0] !== dateKey);
            // preAssignedShifts = {}; // Do not clear all preAssignedShifts on date deletion
            // To be safe, remove only the shifts for the deleted date
            staffList.forEach(name => {
                if (preAssignedShifts[name]) {
                    delete preAssignedShifts[name][dateKey];
                    if (Object.keys(preAssignedShifts[name]).length === 0) {
                        delete preAssignedShifts[name];
                    }
                }
            });
            window.renderPreAssignedShifts();
            window.renderSelectedDates();
            window.populateAllDropdowns(); // RENAME
            window.validateInputs(); 
            window.saveData && window.saveData();
        };

        window.getTypeLabel = (type) => {
             if (type === 'Clinic_MWTH') return '門診日 (一三四)';
             if (type === 'Clinic_TF') return '門診日 (二五)';
             if (type === 'Saturday') return '禮拜六班';
             if (type === 'SundayHoliday') return '禮拜日/國定假';
             return '未知類型';
        };

        window.renderSelectedDates = () => {
            const container = document.getElementById('selectedDatesContainer');
            if (datesWithTypes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm italic p-1 text-center">尚未選擇任何日期</p>';
                return;
            }
            container.innerHTML = datesWithTypes.map(item => {
                const dateKey = item.dateObj.toISOString().split('T')[0];
                const displayStr = window.formatDate(item.dateObj);
                let typeLabel = window.getTypeLabel(item.type);
                // 使用中性灰色背景
                let typeClass = 'bg-gray-200 text-gray-800';
                
                return `
                    <div class="flex justify-between items-center bg-white p-2 rounded-lg shadow-sm border border-gray-200">
                        <span class="text-sm font-medium text-gray-700">${displayStr}</span>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${typeClass}">${typeLabel}</span>
                            <button type="button" onclick="window.removeDate('${dateKey}')" class="text-red-500 hover:text-red-700 transition duration-150 p-1 rounded-full hover:bg-red-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm6 3a1 1 0 100 2h-4a1 1 0 100-2h4z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        };
        
        /**
         * 格式化日期為月/日 (週X)
         */
        function formatDate(date) {
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const dayOfWeek = ['日', '一', '二', '三', '四', '五', '六'][date.getDay()];
            return `${month}/${day} (週${dayOfWeek})`;
        }
        
        /**
         * NEW: 格式化日期為 日期 + 星期 (用於表格頭部)
         */
        function formatDayAndWeek(date) {
            const day = date.getDate().toString();
            const dayOfWeek = ['日', '一', '二', '三', '四', '五', '六'][date.getDay()];
            return { day: day, week: dayOfWeek };
        }


        window.generateMonthlyDates = (startDate, daysInMonth) => {
            datesWithTypes = [];
            const year = startDate.getFullYear();
            const month = startDate.getMonth();
            for (let i = 1; i <= daysInMonth; i++) {
                // dateObj must be created locally for accurate dayOfWeek and ISO key calculation
                const dateObj = new Date(year, month, i, 0, 0, 0, 0);
                const dayOfWeek = dateObj.getDay();
                let dateType;
                if (dayOfWeek === 0) { dateType = 'SundayHoliday'; } 
                else if (dayOfWeek === 6) { dateType = 'Saturday'; } 
                else if (dayOfWeek === 1 || dayOfWeek === 3 || dayOfWeek === 4) { dateType = 'Clinic_MWTH'; } 
                else if (dayOfWeek === 2 || dayOfWeek === 5) { dateType = 'Clinic_TF'; } 
                else { dateType = 'Clinic_MWTH'; }
                datesWithTypes.push({ dateObj, type: dateType });
            }

            // preAssignedShifts = {}; // Do not clear manual shifts, maintain persistence.
            window.renderPreAssignedShifts();
            window.renderSelectedDates();
            window.populateAllDropdowns(); // RENAME
            window.validateInputs();
            window.renderShiftAvailability();
            window.saveData && window.saveData();
            window.showMessage(`✅ 已生成 ${year}年${month + 1}月 共 ${daysInMonth} 天的班表。周末日已自動標記為對應班別。`, 'success');
        };

        window.triggerMonthGeneration = () => {
            const input = document.getElementById('monthStartInput');
            const dateStr = input.value;
            if (!dateStr) { window.showMessage('❌ 請選擇一個有效的月份中的任一天。', 'error'); return; }
            
            // FIX: 使用 safeDateFromISO 確保時區正確
            const startDate = safeDateFromISO(dateStr);
            if (isNaN(startDate.getTime())) { window.showMessage('❌ 無效的日期格式。', 'error'); return; }
            const year = startDate.getFullYear();
            const month = startDate.getMonth();
            const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
            window.generateMonthlyDates(startDate, lastDayOfMonth);
        };

        window.showMessage = (msg, type) => {
            const msgDiv = document.getElementById('validationMessage');
            msgDiv.innerHTML = msg;
            msgDiv.classList.remove('hidden', 'text-red-500', 'bg-red-50', 'border-red-200', 'text-blue-800', 'bg-blue-50', 'border-blue-200');

            if (type === 'error') {
                msgDiv.classList.add('text-red-500', 'bg-red-50', 'border-red-200');
            } else {
                msgDiv.classList.add('text-blue-800', 'bg-blue-50', 'border-blue-200');
            }
            msgDiv.classList.remove('hidden');
        };


        // Helper to get a random shift from a pool
        function getRandomShift(shiftArray) {
            if (!shiftArray || shiftArray.length === 0) return restShiftName;
            const randomIndex = Math.floor(Math.random() * shiftArray.length);
            return shiftArray[randomIndex];
        }


        // --- 核心排班邏輯函數 ---
        
        /**
         * 領導班別硬性分配邏輯 (莉娟/麗雯/佩君)
         * 莉娟/麗雯/佩君: 只要是「禮拜日/國定假」就強制休息，否則套用固定班。
         */
        function applyLeaderAssignments() {
            const leaderRules = {
                '莉娟': { MonFri: 'CO', Sat: restShiftName, Sun: restShiftName, shiftName: 'CO' },
                '麗雯': { MonFri: 'CO', Sat: 'I3', Sun: restShiftName, shiftName: 'CO' },
                '佩君': { MonFri: 'CO*', Sat: 'I3', Sun: restShiftName, shiftName: 'CO*' }
            };

            const rotationStartInput = document.getElementById('rotationStartDate').value;
            const rotationStart = rotationStartInput ? safeDateFromISO(rotationStartInput) : null;
            const rotationStartTime = rotationStart ? rotationStart.getTime() : null;
            
            // 1. 清空領導組的排班，但保留手動設定的特休/休假/婚假
            const LEAVE_SHIFTS = [restShiftName, ANNUAL_LEAVE_SHIFT, WEDDING_LEAVE_SHIFT];
            
            // WARNING: For 莉娟/麗雯, we keep this to enforce their fixed schedule unless manual leave is set.
            // For 佩君, we keep this to clear fixed CO/CO* which is now handled by the generic manual override rule.
            Object.keys(leaderRules).forEach(name => {
                if (staffList.includes(name)) {
                    preAssignedShifts[name] = preAssignedShifts[name] || {};
                    // 清空領導組的排班，但保留手動設定的特休/休假/婚假
                    const manualLeaves = Object.entries(preAssignedShifts[name]).filter(([dateKey, shift]) => LEAVE_SHIFTS.includes(shift));
                    preAssignedShifts[name] = Object.fromEntries(manualLeaves);
                }
            });
            
            // 2. Apply rules
            datesWithTypes.forEach(item => {
                const { dateObj } = item;
                const dateKey = dateObj.toISOString().split('T')[0];
                const dayOfWeek = dateObj.getDay();
                const dateType = item.type;
                const req = requirements[dateType];

                let weekNumber = null;
                if (rotationStartTime) {
                    const dayDiff = Math.floor((dateObj.getTime() - rotationStartTime) / MS_PER_DAY);
                    weekNumber = Math.floor(dayDiff / 7);
                }

                Object.keys(leaderRules).forEach(name => {
                    if (!staffList.includes(name)) return;
                    
                    const manualShift = preAssignedShifts[name]?.[dateKey]; 
                    const isManualLeave = LEAVE_SHIFTS.includes(manualShift); // Check against all leave types

                    const rules = leaderRules[name];
                    let expectedShiftIfWorking = rules.shiftName; // Default weekday shift
                    if (dayOfWeek === 6) expectedShiftIfWorking = rules.Sat;
                    if (dayOfWeek === 0 || dateType === 'SundayHoliday') expectedShiftIfWorking = restShiftName;

                    // --- 檢查手動覆蓋 (只有休/特休/婚假會通過此檢查，因為 work shifts 被清除了) ---
                    if (isManualLeave) {
                        // Compensation: only Peijun needs compensation
                        const NO_COMPENSATION_STAFF = ['莉娟', '麗雯'];
                        if (!NO_COMPENSATION_STAFF.includes(name) && expectedShiftIfWorking !== restShiftName) { 
                            if (req && req[expectedShiftIfWorking]) {
                                req[expectedShiftIfWorking].count = (req[expectedShiftIfWorking].count || 0) + 1;
                            }
                        }
                        return; // Skip fixed assignment
                    }
                    
                    // --- 正常固定班表分配 (已修正佩君在周一至周五強制休息邏輯) ---
                    let assignedShift = null;
                    const isForcedRest = dateType === 'SundayHoliday' || dayOfWeek === 0;

                    // A. 處理強制休息日 (周日 / 國定假 / 用戶標記的假日)
                    if (isForcedRest) {
                        if (LEADER_NAMES.includes(name)) { // 莉娟, 麗雯, 佩君
                            assignedShift = restShiftName;
                        }
                    } else {
                        // B. 處理周一至周六的固定工作
                        if (name === '莉娟' || name === '麗雯' || name === '佩君') {
                            if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                                // 周一至周五：CO / CO*
                                assignedShift = rules.MonFri;
                            } else if (dayOfWeek === 6 && name === '莉娟') {
                                // 莉娟 周六固定休
                                assignedShift = rules.Sat; // '休'
                            }
                            // 麗雯/佩君的周六 I3 輪替邏輯在 applyRegularStaffAssignments，不需要在這裡寫入
                        }
                    }
                    
                    if (assignedShift) {
                        preAssignedShifts[name][dateKey] = assignedShift;
                    }
                });
            });
        }

        /**
         * NEW: 獲取已選定的正常班人員名稱列表 (最多兩位)
         */
        function getRegularStaffNames() {
            const regStaff1Name = document.getElementById('regStaff1Select').value;
            const regStaff2Name = document.getElementById('regStaff2Select').value;
            return [regStaff1Name, regStaff2Name].filter(name => name);
        }

        /**
         * NEW: 正常班組 (正1/正2) 和領導組 I3 輪替邏輯 (基於日曆週轉換)
         * 服務台/轉診中心/正常班組: 任何手動鎖定都會跳過固定班，並在手動休/特休時觸發補償。
         */
        function applyRegularStaffAssignments(staffList) {
            const regStaffNames = getRegularStaffNames();
            const regStaff1 = regStaffNames[0];
            const regStaff2 = regStaffNames[1];
            const LEAVE_SHIFTS = [restShiftName, ANNUAL_LEAVE_SHIFT, WEDDING_LEAVE_SHIFT]; // NEW

            // 處理 I3 輪替的 4 位人員名單 (麗雯, 佩君, 正1, 正2)
            const I3_ROTATORS_NAMES = LEADER_NAMES.filter(name => name !== '莉娟').concat(regStaffNames).filter(name => staffList.includes(name)); 

            if (I3_ROTATORS_NAMES.length < 2 && regStaffNames.length === 0) return;
            
            const rotationStartInput = document.getElementById('rotationStartDate').value;
            if (!rotationStartInput) { return; }
            const rotationStart = safeDateFromISO(rotationStartInput);
            
            // 1. 建立 rotation Anchor
            let rotationAnchor = new Date(rotationStart.getTime());
            let dayOfWeekStart = rotationAnchor.getDay(); // 0=Sun, 1=Mon...
            let daysToSubtract = (dayOfWeekStart === 0) ? 6 : (dayOfWeekStart - 1); 
            rotationAnchor.setDate(rotationAnchor.getDate() - daysToSubtract);
            const rotationAnchorTime = rotationAnchor.getTime();

            // 2. 移除清空工作班次的邏輯 (以尊重 manual override work shift)
            // [...].forEach(name => { ... }); REMOVED

            datesWithTypes.forEach(item => {
                const { dateObj } = item;
                const dateKey = dateObj.toISOString().split('T')[0];
                const dayOfWeek = dateObj.getDay();
                const dateType = item.type;
                const req = requirements[dateType];

                // 核心變動：計算基於 "Rotation Anchor Monday" 的周數
                const dayDiff = Math.floor((dateObj.getTime() - rotationAnchorTime) / MS_PER_DAY);
                const weekNumber = Math.floor(dayDiff / 7);
                const weekMod2 = weekNumber % 2; // 0: Week 1/3 (Odd), 1: Week 2/4 (Even)
                const weekMod4 = weekNumber % 4;

                const isForcedRest = dateType === 'SundayHoliday' || dayOfWeek === 0;

                // --- A. 周六 I3 班次 4 人輪替 (麗雯, 佩君, 正1, 正2) ---
                if (dayOfWeek === 6 && dateType === 'Saturday' && !isForcedRest) {
                    if (I3_ROTATORS_NAMES.length >= 4) {
                        const I3_ASSIGNED_TO = I3_ROTATORS_NAMES[weekMod4];
                        
                        I3_ROTATORS_NAMES.forEach(name => {
                            preAssignedShifts[name] = preAssignedShifts[name] || {}; // ** FIX: 初始化 **
                            const manualShift = preAssignedShifts[name]?.[dateKey]; // NEW: Check for ANY manual shift
                            const isAssignedI3 = name === I3_ASSIGNED_TO;

                            if (manualShift) { // ** 發現手動鎖定，跳過固定排班 **
                                const isManualLeave = LEAVE_SHIFTS.includes(manualShift); // NEW: Check all leave types
                                
                                if (isManualLeave && isAssignedI3) { // Compensation ONLY if they were assigned I3
                                    // Compensation: if the assigned I3 person is on manual leave, compensate demand (麗雯 is excluded from comp.)
                                    if (name !== '麗雯') {
                                        if (req && req['I3']) { req['I3'].count = (req['I3'].count || 0) + 1; }
                                    }
                                }
                                return; // Skip fixed I3 assignment
                            }
                            
                            // Normal Assignment (Only runs if NO manualShift is found)
                            if (isAssignedI3) {
                                preAssignedShifts[name][dateKey] = 'I3';
                            } else if (LEADER_NAMES.includes(name) || regStaffNames.includes(name)) {
                                // Other I3 rotators take rest
                                preAssignedShifts[name][dateKey] = preAssignedShifts[name]?.[dateKey] || restShiftName;
                            }
                        });
                        // Ensure I3 demand is reduced by 1 for the fixed assignment (if it happened)
                        if (req && req['I3']) { req['I3'].count = Math.max(1, req['I3'].count); } 
                    } else if (I3_ROTATORS_NAMES.length > 0) {
                        // If not enough people for rotation, force rest (only if no manual shift was present)
                        I3_ROTATORS_NAMES.forEach(name => {
                             preAssignedShifts[name] = preAssignedShifts[name] || {}; // ** FIX: 初始化 **
                             const manualShift = preAssignedShifts[name]?.[dateKey];
                             if (!manualShift) { // Apply rest only if no manual override
                                 preAssignedShifts[name][dateKey] = restShiftName;
                             }
                        });
                    }
                }
                
                // --- B. 周六/周日/國定假日固定休假 (針對正常班人員) ---
                // If it's a fixed rest day OR (Saturday and not I3 day for them) -> assign rest.
                if (isForcedRest || dayOfWeek === 0 || dayOfWeek === 6) { 
                    regStaffNames.forEach(name => {
                        preAssignedShifts[name] = preAssignedShifts[name] || {}; // ** FIX: 初始化 **
                        const manualShift = preAssignedShifts[name]?.[dateKey]; // Check for ANY manual shift
                        const isI3Assigned = preAssignedShifts[name]?.[dateKey] === 'I3';
                        
                        if (manualShift) {
                            // If a manual shift exists (work or leave), skip forced rest.
                            // Compensation for leave during forced rest days is NOT needed as no fixed work shift was missed.
                            return;
                        }

                        if (!isI3Assigned) {
                            preAssignedShifts[name][dateKey] = restShiftName;
                        }
                    });
                    // Skip Mon-Fri logic for weekend/forced holiday
                    return;
                }
                
                // --- C. 正常班組 周間輪替 (Mon-Fri) ---
                if (regStaff1 && regStaff2 && dayOfWeek >= 1 && dayOfWeek <= 5) {
                    
                    const isReg1Primary = weekMod2 === 0;
                    const regStaffs = [regStaff1, regStaff2];

                    regStaffs.forEach(name => {
                        preAssignedShifts[name] = preAssignedShifts[name] || {}; // ** FIX: 初始化 **
                        const manualShift = preAssignedShifts[name]?.[dateKey]; // NEW: Check for ANY manual shift
                        const isReg1 = name === regStaff1;
                        const isPrimary = isReg1 ? isReg1Primary : !isReg1Primary;
                        
                        const otherStaffName = isReg1 ? regStaff2 : regStaff1;
                        const isOtherPrimary = isReg1 ? !isReg1Primary : isReg1Primary;
                        const isOtherOnLeave = LEAVE_SHIFTS.includes(preAssignedShifts[otherStaffName]?.[dateKey]); // NEW: Check all leave types
                        
                        // 1. Determine the FIXED shift that would be assigned (for compensation check later)
                        let expectedFixedShift = isPrimary ? 'A3' : (isOtherOnLeave && isOtherPrimary ? 'A3' : getRandomShift(REGULAR_STAFF_SECONDARY_SHIFTS[dateType]));

                        if (manualShift) { // ** 發現手動鎖定，跳過固定排班 **
                            const isManualLeave = LEAVE_SHIFTS.includes(manualShift); // NEW: Check all leave types
                            
                            if (isManualLeave && expectedFixedShift !== restShiftName) {
                                // Compensation: If staff is on leave, and fixed shift was a WORK shift.
                                if (req && req[expectedFixedShift]) { req[expectedFixedShift].count = (req[expectedFixedShift].count || 0) + 1; }
                            }
                            return; // Skip fixed assignment.
                        }
                        
                        // --- Normal Fixed Working Assignment (Only runs if NO manualShift is found) ---
                        let assignedShift = expectedFixedShift;
                        
                        if (assignedShift) {
                            preAssignedShifts[name][dateKey] = assignedShift;
                            
                            // Reduce Requirement (only for secondary shift or secondary staff covering A3)
                            if (assignedShift !== 'A3' && req && req[assignedShift]) { 
                                if (req[assignedShift]) {
                                    req[assignedShift].count = Math.max(0, (req[assignedShift].count || 0) - 1); 
                                }
                            }
                        }
                    });
                }
            });
        }

        /**
         * 服務台 (SD) / 轉診中心 (RC) 兩週輪班邏輯 (基於日曆週轉換)
         * 服務台/轉診中心/正常班組: 任何手動鎖定都會跳過固定班，並在手動休/特休時觸發補償。
         */
        function applySpecialAssignments(staffList) {
            const sdStaff = staffList.filter(name => staffDataMap[name]?.group === '服務台組');
            const rcStaff = staffList.filter(name => staffDataMap[name]?.group === '轉診中心組');
            const LEAVE_SHIFTS = [restShiftName, ANNUAL_LEAVE_SHIFT, WEDDING_LEAVE_SHIFT]; // NEW
            
            if (sdStaff.length === 0 && rcStaff.length === 0) return;

            const rotationStartInput = document.getElementById('rotationStartDate').value;
            if (!rotationStartInput) { return; }
            const rotationStart = safeDateFromISO(rotationStartInput);
            
            // 1. 建立 rotation Anchor
            let rotationAnchor = new Date(rotationStart.getTime());
            let dayOfWeekStart = rotationAnchor.getDay(); // 0=Sun, 1=Mon...
            let daysToSubtract = (dayOfWeekStart === 0) ? 6 : (dayOfWeekStart - 1); 
            rotationAnchor.setDate(rotationAnchor.getDate() - daysToSubtract);
            const rotationAnchorTime = rotationAnchor.getTime();


            // 2. 移除清空工作班次的邏輯 (以尊重 manual override work shift)
            // [...].forEach(name => { ... }); REMOVED

            datesWithTypes.forEach(item => {
                const { dateObj } = item;
                const dateKey = dateObj.toISOString().split('T')[0];
                const dayOfWeek = dateObj.getDay();
                const dateType = item.type;
                const req = requirements[dateType];

                // 核心變動：計算基於 "Rotation Anchor Monday" 的周數
                const dayDiff = Math.floor((dateObj.getTime() - rotationAnchorTime) / MS_PER_DAY);
                const weekNumber = Math.floor(dayDiff / 7);
                const isWeek1 = weekNumber % 2 === 0; // 0: Week 1/3 (Even), 1: Week 2/4 (Odd)
                
                const isForcedRest = dateType === 'SundayHoliday' || dayOfWeek === 0;

                let expectedSdShift = restShiftName;
                let expectedRcShift = restShiftName;
                
                if (isForcedRest) { // Holiday or Sunday -> Rest
                    expectedSdShift = restShiftName;
                    expectedRcShift = restShiftName;
                } else if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Mon-Fri (Special Rotation)
                    // *** 核心變更：SD 和 RC 的 Mon-Fri 輪班班別對調 ***
                    if (isWeek1) {
                        expectedSdShift = 'CO台';
                        expectedRcShift = 'F台';
                    } else {
                        expectedSdShift = 'F台';
                        expectedRcShift = 'CO台';
                    }
                } else if (dayOfWeek === 6) { // Saturday (D1台 平均)
                    if (isWeek1) {
                        expectedSdShift = 'D1台'; // SD gets D1 in Week 1
                        expectedRcShift = restShiftName;
                    } else {
                        expectedSdShift = restShiftName;
                        expectedRcShift = 'D1台'; // RC gets D1 in Week 2
                    }
                }
                
                // 2. SD Staff (服務台)
                sdStaff.forEach(name => {
                    preAssignedShifts[name] = preAssignedShifts[name] || {}; // ** FIX: 初始化 **
                    const manualShift = preAssignedShifts[name]?.[dateKey]; // ** NEW: Check for ANY manual shift **
                    
                    if (manualShift) { // ** 發現手動鎖定，跳過固定排班 **
                        const isManualLeave = LEAVE_SHIFTS.includes(manualShift); // NEW: Check all leave types
                        
                        if (isManualLeave) {
                            // SD休假，觸發需求補償
                            if (expectedSdShift !== restShiftName && req && req[expectedSdShift]) {
                                req[expectedSdShift].count = (req[expectedSdShift].count || 0) + 1;
                            }
                        }
                        return; // 跳過固定分配
                    }
                    
                    // 正常分配 (Only runs if NO manualShift is found)
                    preAssignedShifts[name][dateKey] = expectedSdShift;
                    // SD 固定人員工作，需要減少輪班人員的壓力
                    if (expectedSdShift !== restShiftName && req && req[expectedSdShift]) {
                        req[expectedSdShift].count = Math.max(0, (req[expectedSdShift].count || 0) - 1);
                    }
                });

                // 3. RC Staff (轉診中心)
                rcStaff.forEach(name => {
                    preAssignedShifts[name] = preAssignedShifts[name] || {}; // ** FIX: 初始化 **
                    const manualShift = preAssignedShifts[name]?.[dateKey]; // ** NEW: Check for ANY manual shift **

                    if (manualShift) { // ** 發現手動鎖定，跳過固定排班 **
                        const isManualLeave = LEAVE_SHIFTS.includes(manualShift); // NEW: Check all leave types

                        if (isManualLeave) {
                            // RC休假，觸發需求補償
                            if (expectedRcShift !== restShiftName && req && req[expectedRcShift]) {
                                req[expectedRcShift].count = (req[expectedRcShift].count || 0) + 1;
                            }
                        }
                        return; // 跳過固定分配
                    }
                    
                    // 正常分配 (Only runs if NO manualShift is found)
                    preAssignedShifts[name][dateKey] = expectedRcShift;
                    // RC 固定人員工作，需要減少輪班人員的壓力
                    if (expectedRcShift !== restShiftName && req && req[expectedRcShift]) {
                        req[expectedRcShift].count = Math.max(0, (req[expectedRcShift].count || 0) - 1);
                    }
                });
                
                // 4. 處理周六 D1台 需求調整 (確保至少有 1 個需求)
                const d1ShiftName = 'D1台';
                if (dayOfWeek === 6 && req && !req[d1ShiftName]) {
                    // Force minimum required shift definition
                    req[d1ShiftName] = { count: 1, timeSlot: '08:00-12:00', restingMinutes: 0, timeMeta: parseShiftTime('08:00-12:00') }; // NEW: add restingMinutes
                }
            });
        }

        /**
         * NEW: 實現班次需求計算和顯示功能
         */
        
        /**
         * 計算所有日期中每個班別的總需求和已鎖定分配量 (Manual/Fixed)。
         * @returns {Object<string, {required: number, assigned: number}>}
         */
        function calculateTotalShiftAllocation() {
            const allocation = {}; // {shiftName: {required: N, assigned: M}}

            // 1. 遍歷所有日期類型和所有班別，計算總需求
            ['Clinic_MWTH', 'Clinic_TF', 'Saturday', 'SundayHoliday'].forEach(type => {
                const baseDailyReq = requirements[type]; 
                
                datesWithTypes.filter(d => d.type === type).forEach((item) => {
                    // Tally base required slots for this day
                    Object.keys(baseDailyReq).forEach(shiftName => {
                        if (shiftName !== restShiftName && shiftName !== ANNUAL_LEAVE_SHIFT && shiftName !== WEDDING_LEAVE_SHIFT) { // NEW: Exclude Wedding Leave
                            if (!allocation[shiftName]) {
                                allocation[shiftName] = { required: 0, assigned: 0 };
                            }
                            allocation[shiftName].required += baseDailyReq[shiftName].count || 0;
                        }
                    });
                });
            });

            // 2. 遍歷所有手動鎖定和固定班表，計算已分配量
            const LEAVE_SHIFTS = [restShiftName, ANNUAL_LEAVE_SHIFT, WEDDING_LEAVE_SHIFT]; // NEW: Define leave shifts here

            staffList.forEach(name => {
                const assignedShifts = preAssignedShifts[name] || {};
                Object.entries(assignedShifts).forEach(([, shiftString]) => {
                    const shifts = shiftString.split(',').map(s => s.trim()).filter(s => !LEAVE_SHIFTS.includes(s)); // Filter out all leave types
                    shifts.forEach(shift => {
                        if (allocation[shift]) {
                            allocation[shift].assigned += 1;
                        }
                    });
                });
            });

            return allocation;
        }

        window.renderShiftAvailability = () => {
            // 先確保數據結構是最新的
            window.updateRequirementsFromInputs();
            window.parseStaffData();

            // FIX: 儲存原始參考，並在深層複製時確保使用有效的物件作為來源 (修復 JSON.parse("undefined") 錯誤)
            const originalRequirementsRef = window.requirements;
            const originalPreAssignedShiftsRef = preAssignedShifts;
            
            // Deep clone.
            const tempRequirements = JSON.parse(JSON.stringify(requirements));
            const tempPreAssignedShifts = JSON.parse(JSON.stringify(originalPreAssignedShiftsRef)); 
            
            // Temporarily overwrite globals with clones for fixed assignment run
            window.requirements = tempRequirements;
            preAssignedShifts = tempPreAssignedShifts;
            
            // Run fixed assignments (which modifies requirements and preAssignedShifts based on manual leave)
            applyLeaderAssignments();
            applySpecialAssignments(staffList);
            applyRegularStaffAssignments(staffList); 
            
            // Now calculate the net demand for rotation staff based on the modified data
            const allocation = {};

            ['Clinic_MWTH', 'Clinic_TF', 'Saturday', 'SundayHoliday'].forEach(type => {
                datesWithTypes.filter(d => d.type === type).forEach((item) => {
                    Object.keys(tempRequirements[type]).forEach(shiftName => {
                        if (shiftName !== restShiftName && shiftName !== ANNUAL_LEAVE_SHIFT && shiftName !== WEDDING_LEAVE_SHIFT) { // NEW: Exclude Wedding Leave
                            // Only count if demand exists for this day type
                            const count = tempRequirements[type][shiftName].count || 0;
                            if (!allocation[shiftName]) {
                                allocation[shiftName] = { required: 0 };
                            }
                            allocation[shiftName].required += count;
                        }
                    });
                });
            });
            
            // Restore original global state
            window.requirements = originalRequirementsRef;
            preAssignedShifts = originalPreAssignedShiftsRef;


            const container = document.getElementById('availabilityStatus');

            let html = '<p class="text-sm font-bold text-gray-800 mb-2 border-b border-gray-300 pb-2">工作班次剩餘名額 (輪班人員所需)：</p>';

            if (Object.keys(allocation).length === 0) {
                html += '<p class="text-xs text-gray-500 italic">請先新增日期和定義班別需求。</p>';
            } else {
                const tableRows = Object.entries(allocation)
                    .filter(([, data]) => data.required > 0)
                    .sort(([shiftA], [shiftB]) => shiftA.localeCompare(shiftB, 'zh-TW'))
                    .map(([shiftName, data]) => {
                        const remaining = data.required;
                        const remainingClass = remaining > 0 ? 'text-blue-600 font-bold' : 'text-green-600'; 
                        const warning = remaining > 0 ? ' (待分配)' : '';

                        return `
                            <div class="flex justify-between text-xs py-1 border-b border-gray-200">
                                <span class="font-medium text-gray-700">${shiftName}</span>
                                <span class="${remainingClass} font-mono">
                                    ${remaining} ${warning}
                                </span>
                            </div>
                        `;
                    }).join('');
                
                if (tableRows) {
                    html += `<div class="space-y-1">${tableRows}</div>`;
                } else {
                    html += '<p class="text-xs text-green-600 font-medium italic">✅ 所有工作班次需求已被固定班表完全覆蓋。</p>';
                }
            }

            container.innerHTML = html;
        };
        
        // ... (validateInputs function remains the same) ...

        window.validateInputs = () => {
            // NEW: 讀取最新的輸入狀態到隱藏欄位，用於驗證
            updateCarryOverTextFromInputs(false); 
            updateAnnualLeaveTextFromInputs(false);
            updateSettlementHoursTextFromInputs(false);

            window.updateRequirementsFromInputs();
            window.parseStaffData();

            const staffText = document.getElementById('staffNames').value.trim();
            restShiftName = document.getElementById('restShiftName').value.trim() || '休';

            let messages = [];

            if (datesWithTypes.length === 0) { messages.push("❌ 請輸入有效的排班日期 (至少選擇一個日期)。"); }
            if (staffList.length === 0) { messages.push("❌ 請輸入人員名單。"); }
            const totalStaff = staffList.length;

            let allShiftNamesForRestCheck = new Set();
            
            ['Clinic_MWTH', 'Clinic_TF', 'Saturday', 'SundayHoliday'].forEach(type => {
                const dailyReq = requirements[type];
                let totalRequired = 0;
                
                const typeLabel = window.getTypeLabel(type);
                
                Object.keys(dailyReq).forEach(shiftName => {
                    const shift = dailyReq[shiftName];
                    if (shiftName !== restShiftName && shiftName !== ANNUAL_LEAVE_SHIFT && shiftName !== WEDDING_LEAVE_SHIFT) { // NEW: Exclude Wedding Leave
                        if (!shift.timeMeta) { messages.push(`❌ [${typeLabel}] 班別 "${shiftName}" 的時段格式錯誤或無效: ${shift.timeSlot}。`); }
                        if (shiftName === restShiftName) { messages.push(`❌ 工作班別名稱 "${shiftName}" 與休假班別名稱衝突。`); }
                        allShiftNamesForRestCheck.add(shiftName);
                        totalRequired += shift.count;
                    }
                });

                const restCount = totalStaff - totalRequired;
                if (requirements[type][restShiftName]) { requirements[type][restShiftName].count = restCount; }
                // 特休/婚假不計入系統自動分配的休假名額，其 count 保持為 0
                if (requirements[type][ANNUAL_LEAVE_SHIFT]) { requirements[type][ANNUAL_LEAVE_SHIFT].count = 0; }
                if (requirements[type][WEDDING_LEAVE_SHIFT]) { requirements[type][WEDDING_LEAVE_SHIFT].count = 0; } // NEW: Set 婚假 count


                if (restCount < 0 && totalStaff > 0) {
                    messages.push(`❌ [${typeLabel}] 所需總人數 (${totalRequired}) 超過總人數 (${totalStaff})。請減少所需人數。`);
                }
            });

            if (allShiftNamesForRestCheck.has(restShiftName)) { messages.push(`❌ 休假班別名稱 "${restShiftName}" 與任何工作班別名稱衝突。`); }
            if (allShiftNamesForRestCheck.has(ANNUAL_LEAVE_SHIFT)) { messages.push(`❌ 特休班別名稱 "${ANNUAL_LEAVE_SHIFT}" 與任何工作班別名稱衝突。`); }
            if (allShiftNamesForRestCheck.has(WEDDING_LEAVE_SHIFT)) { messages.push(`❌ 婚假班別名稱 "${WEDDING_LEAVE_SHIFT}" 與任何工作班別名稱衝突。`); } // NEW: Check wedding leave name

            
            // NEW: 跨月狀態驗證 (簡化驗證，因為主要通過介面輸入)
            const carryOverStatus = parseCarryOverStatus();
            const staffBalances = parseStaffBalances();

            staffList.forEach(name => {
                if (!staffList.includes(name) && (carryOverStatus[name] || staffBalances[name])) {
                    // This warning is now handled in parseStaffData where inputs are filtered by staffList
                    // messages.push(`⚠️ [平衡狀態] 人員 ${name} 不在「全體人員名單」中，該狀態將被忽略。`);
                }
            });

            if (messages.length > 0) {
                window.showMessage(messages.join('<br>'), 'error');
                return false;
            } else if (totalStaff > 0 && datesWithTypes.length > 0) {
                let mwthRest = requirements.Clinic_MWTH[restShiftName]?.count || 0;
                let tfRest = requirements.Clinic_TF[restShiftName]?.count || 0;
                let satRest = requirements.Saturday[restShiftName]?.count || 0;
                let sunHolRest = requirements.SundayHoliday[restShiftName]?.count || 0; 
                
                let msg = `✅ 驗證成功。總人數 ${totalStaff} 人。每日休假人數：`;
                if (mwthRest >= 0) msg += ` 門診(一三四)排 ${mwthRest} 人休假。`;
                if (tfRest >= 0) msg += ` 門診(二五)排 ${tfRest} 人休假。`;
                if (satRest >= 0) msg += ` 禮拜六排 ${satRest} 人休假。`;
                if (sunHolRest >= 0) msg += ` 禮拜日/國定假排 ${sunHolRest} 人休假。`;
                
                window.showMessage(msg, 'success');
            } else {
                document.getElementById('validationMessage').classList.add('hidden');
            }

            return messages.length === 0;
        };

        window.generateSchedule = () => {
            if (!window.validateInputs()) {
                document.getElementById('scheduleOutput').classList.add('hidden');
                return;
            }

            // 0. 重新初始化和應用固定班表
            const originalRequirements = JSON.parse(JSON.stringify(requirements));
            const LEAVE_SHIFTS = [restShiftName, ANNUAL_LEAVE_SHIFT, WEDDING_LEAVE_SHIFT]; // NEW

            
            // Ensure preAssignedShifts for fixed staff only contains manual leave before re-applying fixed assignments
            // ONLY CLEANS UP LEADER'S MANUAL WORK SHIFTS (莉娟/麗雯) to enforce fixed CO/CO* unless leave is taken.
            const FIXED_LEAVE_ONLY_STAFF = ['莉娟', '麗雯']; // Only these two ignore manual work shifts
            staffList.forEach(name => {
                if (FIXED_LEAVE_ONLY_STAFF.includes(name)) {
                    preAssignedShifts[name] = preAssignedShifts[name] || {};
                    const manualLeaves = Object.entries(preAssignedShifts[name]).filter(([dateKey, shift]) => LEAVE_SHIFTS.includes(shift));
                    preAssignedShifts[name] = Object.fromEntries(manualLeaves);
                }
            });
            
            let mutableRequirements = JSON.parse(JSON.stringify(originalRequirements));
            window.requirements = mutableRequirements;
            
            // Call fixed assignments. These functions check for manual overrides (work or leave) 
            // for the respective staff and apply demand compensation if necessary.
            applyLeaderAssignments();
            applySpecialAssignments(staffList);
            applyRegularStaffAssignments(staffList); 
            
            const prevSdName = document.getElementById('prevSdStaffSelect').value;
            const prevRcName = document.getElementById('prevRcStaffSelect').value;

            const carryOverStatus = parseCarryOverStatus();
            // NEW: 載入結餘狀態
            const staffBalances = parseStaffBalances();


            // 1. 初始化員工統計數據
            window.parseStaffData();
            let allShifts = new Set([...Object.keys(requirements.Clinic_MWTH), ...Object.keys(requirements.Clinic_TF), ...Object.keys(requirements.Saturday), ...Object.keys(requirements.SundayHoliday)]);

            staffList.forEach(name => {
                // IMPORTANT: 確保 staffStats 每次都使用 INITIAL BALANCE
                const initialSettlementHours = staffBalances[name]?.settlementHours || 0;
                
                // NEW: Calculate AL rest adjustment based on initial balance (in Hours)
                const initialAnnualLeaveHours = (staffBalances[name]?.annualLeaveDays || 0) * HOURS_PER_ANNUAL_LEAVE_DAY;
                const annualLeaveRestAdjustment = calculateALRestAdjustment(initialAnnualLeaveHours);

                window.staffStats[name] = {
                    restCount: 0,
                    annualLeaveCount: 0,
                    weddingLeaveCount: 0, // NEW: Init Wedding Leave Count
                    satRestCount: 0, // NEW: Init Sat Rest Count
                    sunRestCount: 0, // NEW: Init Sun/Holiday Rest Count (NOW ONLY ACTUAL SUNDAY)
                    totalWorkMinutes: 0,
                    shifts: {},
                    schedule: {}, 
                    lastEndMinOnPreviousDay: 0,
                    lastShiftName: restShiftName,
                    consecutiveWorkDays: 0,
                    consecutiveRestDays: 0,
                    // AnnualLeaveDays is stored in DAYS internally
                    annualLeaveDays: staffBalances[name]?.annualLeaveDays || 0,
                    annualLeaveRestAdjustment: annualLeaveRestAdjustment, // NEW: 休息調整因子
                    
                    // NEW: 結算時數的計算基準 (使用初始值作為基數)
                    settlementHours: initialSettlementHours, 
                    
                    // NEW: Late Shift Counters
                    totalLateShifts: 0,
                    satLateShifts: 0,
                    sunHolLateShifts: 0,
                };
                
                // NEW: 應用跨月狀態
                if (carryOverStatus[name]) {
                    window.staffStats[name].consecutiveWorkDays = carryOverStatus[name].consecutiveWorkDays;
                    window.staffStats[name].consecutiveRestDays = carryOverStatus[name].consecutiveWorkDays === 0 ? 1 : 0; 
                    window.staffStats[name].lastEndMinOnPreviousDay = carryOverStatus[name].lastEndMin;
                }

                allShifts.forEach(shift => {
                    window.staffStats[name].shifts[shift] = 0;
                });
                window.staffStats[name].shifts[ANNUAL_LEAVE_SHIFT] = 0;
                window.staffStats[name].shifts[WEDDING_LEAVE_SHIFT] = 0; // NEW: Init Wedding Leave shift count
            });

            // 2. 逐日排班
            datesWithTypes.forEach(item => {
                const { dateObj, type: dateType } = item;
                const dateKey = dateObj.toISOString().split('T')[0];
                const dayOfWeek = dateObj.getDay();
                
                const baseDailyRequirement = window.requirements[dateType]; 
                const dailyRequirement = JSON.parse(JSON.stringify(baseDailyRequirement));

                let dailySchedule = {};
                let assignedStaff = new Set();
                
                // --- a) 優先分配所有鎖定班表 (包括領導/特殊組 and 預選休假/特休/婚假) ---
                staffList.forEach(name => {
                    const preAssignedShift = preAssignedShifts[name]?.[dateKey];
                    if (preAssignedShift) {
                        dailySchedule[name] = preAssignedShift;
                        assignedStaff.add(name);
                        
                        // This reduces demand for the pre-assigned shift. 
                        const shifts = preAssignedShift.split(',').map(s => s.trim());
                        shifts.forEach(shift => {
                            if (dailyRequirement[shift] && !LEAVE_SHIFTS.includes(shift)) {
                                dailyRequirement[shift].count = Math.max(0, dailyRequirement[shift].count - 1);
                            }
                        });
                    }
                });

                const allWorkingShifts = Object.keys(dailyRequirement).filter(shift => !LEAVE_SHIFTS.includes(shift)); // NEW: Filter all leave types
                
                let remainingStaff = staffList.filter(name => !assignedStaff.has(name));

                // --- b) 進行平衡分配 (工作優先，休假次之) ---

                // --- b.1) 分配剩餘的工作班別 (優先處理) ---
                for (const shiftName of allWorkingShifts) {
                    let countNeeded = dailyRequirement[shiftName].count;
                    const shiftTimeMeta = dailyRequirement[shiftName].timeMeta;

                    if (!shiftTimeMeta) continue;

                    if (countNeeded <= 0) continue; 

                    let candidates = remainingStaff.filter(name => {
                        const staffEntry = window.staffStats[name];
                        const lastEndMin = staffEntry.lastEndMinOnPreviousDay;
                        const lastShiftName = staffEntry.lastShiftName;
                        const currentConsecutiveDays = staffEntry.consecutiveWorkDays;
                        
                        // 只有輪班人員才進入此處的分配池
                        if (staffDataMap[name]?.group !== '輪班人員') return false; 

                        const passesRestRule = checkEightHourRule(lastEndMin, shiftTimeMeta);
                        const passesMaxWorkDays = (currentConsecutiveDays < MAX_CONSECUTIVE_WORK_DAYS);

                        let passesNRule = true;
                        if (shiftName === 'N') {
                            const restrictedShifts = ['D1台', 'I3', 'D1(5)']; // UPDATED: D15 -> D1(5)
                            if (restrictedShifts.includes(lastShiftName)) {
                                passesNRule = false;
                            }
                        }

                        // ** 勞基法約束必須在最外層過濾，否則會導致不適任者被選中 **
                        // ** FIX: 檢查是否可以排班 **
                        return !dailySchedule[name] && passesRestRule && passesNRule && passesMaxWorkDays; 
                    }).sort((a, b) => {
                        
                        // 優先級 1: 上月服務台/轉診中心人員優先代理 SD/RC 班次 (固定組休假補償時) <-- **絕對最高優先級**
                        if (SD_RC_PROXY_SHIFTS.includes(shiftName)) {
                            // 修正邏輯：讓分數為負數者 (即代理人) 排序在前面
                            const isPrevSDA = a === prevSdName ? -100000000 : 0; 
                            const isPrevSDB = b === prevSdName ? -100000000 : 0;
                            if (isPrevSDA !== isPrevSDB) return isPrevSDA - isPrevSDB; 

                            const isPrevRCA = a === prevRcName ? -50000000 : 0; 
                            const isPrevRCB = b === prevRcName ? -50000000 : 0;
                            if (isPrevRCA !== isPrevRCB) return isPrevRCA - isPrevRCB; 
                        }
                        
                        // 優先級 2: N 班次平衡 (次高優先級)
                        if (shiftName === 'N') {
                            const nA = window.staffStats[a].shifts['N'] || 0;
                            const nB = window.staffStats[b].shifts['N'] || 0;
                            
                            // 2a: 總數最少 (保持平均)
                            if (nA !== nB) { return nA - nB; } 
                            
                            // 2b: 連續性優先 (若總數相同，優先排昨天也是 N 的)
                            const lastA = window.staffStats[a].lastShiftName;
                            const lastB = window.staffStats[b].lastShiftName;
                            const isContinuousA = lastA === 'N' ? -1 : 1; // -1 means preferred
                            const isContinuousB = lastB === 'N' ? -1 : 1;

                            if (isContinuousA !== isContinuousB) { return isContinuousA - isContinuousB; }
                        }
                        
                        // ** 優先級 3: 避免 R-W-R (極高懲罰，防止單日工作) **
                        const isRWA = window.staffStats[a].consecutiveRestDays === 1 ? 5000 : 0; 
                        const isRWB = window.staffStats[b].consecutiveRestDays === 1 ? 5000 : 0; 
                        // FIXED: Corrected reference from wrbPenalty to isRWB
                        if (isRWA !== isRWB) { return isRWA - isRWB; } 

                        // 優先級 4: 小夜班次平衡
                        if (LATE_SHIFTS.includes(shiftName)) {
                            const lateA = window.staffStats[a].totalLateShifts || 0;
                            const lateB = window.staffStats[b].totalLateShifts || 0;
                            if (lateA !== lateB) { return lateA - lateB; } 
                        }

                        // 優先級 5: S 班次平衡
                        if (shiftName.startsWith('S')) {
                            const sA = window.staffStats[a].shifts[shiftName] || 0;
                            const sB = window.staffStats[b].shifts[shiftName] || 0;
                            if (sA !== sB) { return sA - sB; } 
                        }
                        
                        // 優先級 6: 該特定班次累積次數最少 (通用班次平衡)
                        const shiftCountA = window.staffStats[a].shifts[shiftName] || 0;
                        const shiftCountB = window.staffStats[b].shifts[shiftName] || 0;
                        if (shiftCountA !== shiftCountB) { return shiftCountA - shiftCountB; } 

                        // 優先級 7: 結算時數較少者優先工作
                        const shA = window.staffStats[a].settlementHours; 
                        const shB = window.staffStats[b].settlementHours;
                        if (shA !== shB) { return shA - shB; } 
                        
                        // 優先級 8: 特休結餘調整因子 (低調整者優先工作，即優先排工)
                        const adjA = window.staffStats[a].annualLeaveRestAdjustment;
                        const adjB = window.staffStats[b].annualLeaveRestAdjustment;
                        if (adjA !== adjB) { return adjA - adjB; } // Lower adjustment sorts first (ascending).

                        // 優先級 9: 總工作班次最少
                        const totalWorkA = Object.keys(window.staffStats[a].shifts).filter(s => !LEAVE_SHIFTS.includes(s)).reduce((sum, s) => sum + (window.staffStats[a].shifts[s] || 0), 0);
                        const totalWorkB = Object.keys(window.staffStats[b].shifts).filter(s => !LEAVE_SHIFTS.includes(s)).reduce((sum, s) => sum + (window.staffStats[b].shifts[s] || 0), 0);
                        if (totalWorkA !== totalWorkB) { return totalWorkA - totalWorkB; }
                        
                        // 優先級 10: 隨機打散平手者
                        return Math.random() - 0.5;
                    });
                    
                    for (let i = 0; i < countNeeded && i < candidates.length; i++) {
                        const staffName = candidates[i];
                        if (!dailySchedule[staffName]) { 
                            dailySchedule[staffName] = shiftName;
                            assignedStaff.add(staffName);
                            remainingStaff = remainingStaff.filter(name => name !== staffName);
                        }
                    }
                }


                // --- b.2) 分配剩餘的休假 (次要處理) ---
                const remainingRestCount = remainingStaff.length; 

                if (remainingRestCount > 0) {
                    
                    // 僅保留休假 (Rest Day) 分配邏輯
                    
                    let restCandidates = remainingStaff.filter(name => {
                        const currentRestDays = window.staffStats[name].consecutiveRestDays || 0;
                        // 僅限輪班人員 and 休息日未達上限
                        return staffDataMap[name]?.group === '輪班人員' && currentRestDays < MAX_CONSECUTIVE_REST_DAYS && !dailySchedule[name];
                    }).sort((a, b) => {
                        // NEW 優先級 1: 特休結餘調整因子 (高特休結餘者優先休息)
                        // We sort by (adjB - adjA) so that higher adjustment (more rest preferred) floats to the top (gets rest).
                        const adjA = window.staffStats[a].annualLeaveRestAdjustment;
                        const adjB = window.staffStats[b].annualLeaveRestAdjustment;
                        if (adjA !== adjB) { return adjB - adjA; } // (CORRECT)

                        // NEW 優先級 2: 結算時數最高者 (高時數者優先休息)
                        const shA = window.staffStats[a].settlementHours; // Use actual settlementHours for sorting
                        const shB = window.staffStats[b].settlementHours;
                        if (shA !== shB) { return shB - shA; } // 高時數者優先休息
                        
                        // ** UPDATED 優先級 3: 避免 W-R-W (高優先級，防止單日休息) **
                        // 確保昨天工作 1 天的人 (consecutiveWorkDays == 1) 有極低的優先級去休息
                        const wraPenalty = window.staffStats[a].consecutiveWorkDays === 1 ? 5000 : 0; // PENALTY INCREASED
                        const wrbPenalty = window.staffStats[b].consecutiveWorkDays === 1 ? 5000 : 0; // PENALTY INCREASED
                        if (wraPenalty !== wrbPenalty) { return wraPenalty - wrbPenalty; } // High penalty for W-R-W pattern
                        
                        // NEW 優先級 4: 周六休假平衡 (最小化差距)
                        if (dayOfWeek === 6) { 
                            const satA = window.staffStats[a].satRestCount || 0;
                            const satB = window.staffStats[b].satRestCount || 0;
                            
                            // Constraint: Avoid staff having 4 or more Saturday rest days. (EXTREME PENALTY)
                            const maxRestPenaltyA = satA >= 4 ? 500000 : 0; // PENALTY INCREASED
                            const maxRestPenaltyB = satB >= 4 ? 500000 : 0; // PENALTY INCREASED
                            if (maxRestPenaltyA !== maxRestPenaltyB) {
                                return maxRestPenaltyA - maxRestPenaltyB; // Penalize hitting 4+
                            }
                            
                            // Normal balance (if penalties are equal)
                            if (satA !== satB) { return satA - satB; }
                        }

                        // NEW 優先級 5: 實際周日休假平衡 (最小化差距)
                        if (dayOfWeek === 0) { // ** 僅限實際周日 **
                            const sunA = window.staffStats[a].sunRestCount || 0;
                            const sunB = window.staffStats[b].sunRestCount || 0;
                            
                            // Constraint: Avoid staff having 4 or more Sunday rest days. (EXTREME PENALTY)
                            const maxRestPenaltyA = sunA >= 4 ? 500000 : 0; // PENALTY INCREASED
                            const maxRestPenaltyB = sunB >= 4 ? 500000 : 0; // PENALTY INCREASED
                            if (maxRestPenaltyA !== maxRestPenaltyB) {
                                return maxRestPenaltyA - maxRestPenaltyB; // Penalize hitting 4+
                            }
                            
                            // Normal balance (if penalties are equal)
                            if (sunA !== sunB) { return sunA - sunB; }
                        }

                        // NEW 優先級 6: 總休假次數最少 (**不含特休/婚假** - 確保輪班人員的實際休息天數平均)
                        const totalLeaveA = window.staffStats[a].restCount; // restCount only counts '休'
                        const totalLeaveB = window.staffStats[b].restCount; 
                        if (totalLeaveA !== totalLeaveB) {
                            return totalLeaveA - totalLeaveB;
                        }
                        
                        // NEW 優先級 7: 隨機打散平手者
                        return Math.random() - 0.5;
                    });
                    
                    // 分配休假
                    restCandidates.forEach(staffName => {
                        if (!dailySchedule[staffName]) {
                            dailySchedule[staffName] = restShiftName;
                            assignedStaff.add(staffName);
                        }
                    });
                }
                
                // --- c) 紀錄排班結果並更新統計數據 ---
                staffList.forEach(name => {
                    const staffEntry = window.staffStats[name];
                    // 檢查是否是多班次分配，如果有多個班次，取第一個作為主要標籤
                    let assignedShift = dailySchedule[name] || restShiftName;
                    
                    // NEW: 累積總工時
                    const duration = getShiftDuration(dailySchedule[name] || restShiftName, dateType);
                    staffEntry.totalWorkMinutes += duration;
                    
                    // 最終結算時數：更新以用於下一天的排序
                    const workingHours = duration / 60;
                    staffEntry.settlementHours += workingHours - 8; 

                    const shiftsToCount = assignedShift.includes(',') ? assignedShift.split(',').map(s => s.trim()) : [assignedShift];
                    
                    shiftsToCount.forEach(shift => {
                        staffEntry.shifts[shift] = (staffEntry.shifts[shift] || 0) + 1;
                    });

                    // 重新定義 assignedShift 為最終顯示的班次（對於多班次，只顯示第一個或'混'）
                    assignedShift = assignedShift.includes(',') ? shiftsToCount[0] : assignedShift;

                    // 連續工作/休息日和結束時間更新
                    if(LEAVE_SHIFTS.includes(assignedShift)) { // NEW: Check all leave types
                        if(assignedShift === restShiftName) staffEntry.restCount++;
                        if(assignedShift === ANNUAL_LEAVE_SHIFT) {
                            staffEntry.annualLeaveCount++;
                            // 只有手動預排的特休才會在此處扣除結餘
                            const isManualAL = preAssignedShifts[name]?.[dateKey] === ANNUAL_LEAVE_SHIFT;
                            if(isManualAL) {
                                // 立即扣除特休結餘 (扣除 1 天, 因為內部是天數)
                                staffEntry.annualLeaveDays = Math.max(0, staffEntry.annualLeaveDays - 1);
                            }
                        }
                        if(assignedShift === WEDDING_LEAVE_SHIFT) { // NEW: Handle Wedding Leave Count
                            staffEntry.weddingLeaveCount++;
                        }
                        
                        // NEW: 周末休假統計 (僅計算 休/特休/婚假)
                        if (dayOfWeek === 6) { staffEntry.satRestCount++; }
                        if (dayOfWeek === 0) { staffEntry.sunRestCount++; } // ** FIX: 僅計算實際周日 **
                        
                        staffEntry.consecutiveWorkDays = 0;
                        staffEntry.consecutiveRestDays++;
                        // 休假或特休，重設 lastEndMin
                        staffEntry.lastEndMinOnPreviousDay = 0; 
                    } else {
                        // 工作班
                        // Need to check all requirements types in case the shift name is generic (like N or D△)
                        const findShiftInfo = (shiftName, currentType) => {
                            // 1. Check current day type
                            if (originalRequirements[currentType]?.[shiftName]) return originalRequirements[currentType][shiftName];
                            
                            // 2. Search all defined types (for cross-day/shared shifts like N, CO台)
                            for (const typeKey in originalRequirements) {
                                if (originalRequirements[typeKey][shiftName]) return originalRequirements[typeKey][shiftName];
                            }
                            return null;
                        };
                        const currentShiftInfo = findShiftInfo(assignedShift, dateType);
                        const shiftMeta = currentShiftInfo?.timeMeta;

                        // 更新 lastEndMinOnPreviousDay
                        if (shiftMeta) { 
                            staffEntry.lastEndMinOnPreviousDay = shiftMeta.endMin; 
                        } else { 
                            // 預設一個非 0 的值，確保 11 小時規則會檢查
                            staffEntry.lastEndMinOnPreviousDay = TOTAL_MINUTES_IN_DAY; 
                        }

                        staffEntry.consecutiveWorkDays++;
                        staffEntry.consecutiveRestDays = 0;

                        // NEW: Late Shift Tally (only for Rotation Staff)
                        const group = staffDataMap[name]?.group;
                        if (group === '輪班人員') {
                            // Check if ANY of the assigned shifts is a late shift
                            const isLateShiftAssigned = shiftsToCount.some(shift => LATE_SHIFTS.includes(shift));

                            if (isLateShiftAssigned) {
                                staffEntry.totalLateShifts = (staffEntry.totalLateShifts || 0) + 1; // Count once per day
                                
                                // FIX: Use local 'dayOfWeek' instead of the incorrect 'item.dayOfWeek'
                                if (dayOfWeek === 6) { // Saturday
                                    staffEntry.satLateShifts = (staffEntry.satLateShifts || 0) + 1;
                                } else if (dayOfWeek === 0 || item.type === 'SundayHoliday') { // Sunday or Holiday
                                    staffEntry.sunHolLateShifts = (staffEntry.sunHolLateShifts || 0) + 1;
                                }
                            }
                        }
                    }

                    staffEntry.lastShiftName = assignedShift;

                    const group = staffDataMap[name]?.group;
                    const isLeaderFixed = group === '領導組' && !LEAVE_SHIFTS.includes(assignedShift);
                    const isRegStaffFixed = group === '正常班組' && !LEAVE_SHIFTS.includes(assignedShift); 
                    const isSpecialFixed = (group === '服務台組' || group === '轉診中心組') && !LEAVE_SHIFTS.includes(assignedShift);
                    const isFixedRotation = isLeaderFixed || isRegStaffFixed || isSpecialFixed;


                    const isManualPreAssigned = !!preAssignedShifts[name]?.[dateKey] && !isFixedRotation;

                    staffEntry.schedule[dateKey] = {
                        shift: dailySchedule[name] || restShiftName, // 儲存包含逗號分隔的多班次字串
                        displayShift: assignedShift, // 儲存單個班次用於顯示
                        type: dateType,
                        preAssigned: isManualPreAssigned,
                        isFixedRotation: isFixedRotation,
                        group: group
                    };
                });
            });
            
            // 3. 計算總班次數 (NEW)
            let totalShiftCounts = {};

            staffList.forEach(name => {
                const staffEntry = window.staffStats[name];
                
                // Accumulate counts from each staff's shift stats
                Object.entries(staffEntry.shifts).forEach(([shift, count]) => {
                    if (!LEAVE_SHIFTS.includes(shift)) { // NEW: Filter out all leave types
                        totalShiftCounts[shift] = (totalShiftCounts[shift] || 0) + count;
                    }
                    // Note: totalLateShifts is already counted in step 2.c for rotation staff (per day).
                });
            });

            // 4. 調整結算時數為 (初始結算時數 + 超額工時) 以符合使用者定義
            const baseHours = parseFloat(document.getElementById('monthlyStandardHours').value) || 0;
            const initialBalances = parseStaffBalances(); // Re-parse initial balances
            
            staffList.forEach(name => {
                const staffEntry = window.staffStats[name];
                // 初始結算時數 (Initial Settlement Hours)
                const initialSettlementHours = initialBalances[name]?.settlementHours || 0; 
                
                // 超額工時 (Excess Hours) = 總工時 - 月基準工時
                const totalHours = (staffEntry.totalWorkMinutes / 60);
                const excessHours = totalHours - baseHours;
                
                // 最終結算時數 = 初始結算時數 + 超額工時
                // Note: The intermediate `staffEntry.settlementHours` was used for sorting; now we set the final value for display/output.
                staffEntry.finalSettlementHours = initialSettlementHours + excessHours; 
                
                // Keep the original `settlementHours` in staffStats as a property for internal tracking if needed,
                // but use `finalSettlementHours` for display and output.
                staffEntry.settlementHours = staffEntry.finalSettlementHours; 
            });

            
            // 5. 渲染結果
            window.renderSchedule(window.staffStats, allShifts, totalShiftCounts);
            window.renderShiftBreakdownSummary(window.staffStats, totalShiftCounts); // 確保 4.1 渲染
            window.renderLateShiftSummary(window.staffStats); 
            window.renderBalanceBreakdownSummary(window.staffStats); // NEW: Render new summary section

            window.saveData && window.saveData();
            
            // 6. 自動觸發 CSV 匯出 (用於更新 CSV 數據)
            window.exportToCSV(false);
        };

        window.renderSchedule = (staffStats, allShifts, totalShiftCounts) => {
            const header = document.getElementById('scheduleHeader');
            const body = document.getElementById('scheduleBody');
            const output = document.getElementById('scheduleOutput');
            const summaryStats = document.getElementById('summaryStats');
            
            header.innerHTML = '';
            body.innerHTML = '';
            const LEAVE_SHIFTS = [restShiftName, ANNUAL_LEAVE_SHIFT, WEDDING_LEAVE_SHIFT]; // NEW

            // 1. 產生表格頭部
            let headerHtml = '<tr class="text-xs sm:text-sm">';
            // FIXED COLUMN 1: 人員/組別 (min-w: 80px)
            headerHtml += '<th class="bg-primary text-white sticky-col sticky-col-1 rounded-tl-lg">人員/組別</th>';
            // FIXED COLUMN 2: 特休結餘 (min-w: 70px) -> UPDATED TO HOURS
            headerHtml += '<th class="bg-primary text-white sticky-col sticky-col-2">特休結餘 (小時)</th>'; 
            // FIXED COLUMN 3: 最終結算 (min-w: 70px)
            headerHtml += '<th class="bg-primary text-white sticky-col sticky-col-3">最終結算 (小時)</th>'; 
            
            // 準備日期數據 (包含 dateObj 以便格式化)
            const sortedDates = datesWithTypes.map(item => ({
                dateISO: item.dateObj.toISOString().split('T')[0],
                dateStr: window.formatDate(item.dateObj), 
                dayOfWeek: item.dateObj.getDay(),
                type: item.type,
                dateObj: item.dateObj // Added for custom formatting
            }));

            // DATE HEADERS
            sortedDates.forEach(item => {
                const dayInfo = window.formatDayAndWeek(item.dateObj);
                const dayClass = item.dayOfWeek === 0 || item.dayOfWeek === 6 ? 'weekend-header' : '';
                // 顯示 Day 和 Week
                headerHtml += `<th class="${dayClass} min-w-[40px]"><span class="text-xs">${dayInfo.day}</span><br><span class="text-xs font-normal opacity-80">${dayInfo.week}</span></th>`;
            });
            
            // =========================================================================
            // FIXED COLUMNS ON THE RIGHT (R1: 休假天數(休), R2: 超額工時)
            // =========================================================================
            // R1: 休假天數 (休 ONLY)
            headerHtml += '<th class="bg-primary text-white sticky-col-r1">休假天數 (休)</th>';
            // R2: 超額工時
            headerHtml += '<th class="bg-primary text-white sticky rounded-tr-lg border-l-2 border-primary sticky-col-excess">超額工時 (小時)</th>';
            headerHtml += '</tr>';
            header.innerHTML = headerHtml;

            // 1.5. Calculate Daily Total Rest Count (Half-day logic implemented here)
            const dailyRestCounts = {};
            sortedDates.forEach(item => {
                const dateKey = item.dateISO;
                let totalRestCount = 0.0; // Use float for half-day calculation
                
                staffList.forEach(name => {
                    const shiftData = staffStats[name]?.schedule[dateKey];
                    const shiftString = shiftData ? shiftData.shift : restShiftName;
                    const shifts = shiftString.split(',').map(s => s.trim());

                    if (shifts.includes(restShiftName)) {
                        totalRestCount += 1.0; // '休' 算作 1.0 天
                    } else if (shifts.includes(ANNUAL_LEAVE_SHIFT) || shifts.includes(WEDDING_LEAVE_SHIFT)) { // NEW: Include Wedding Leave in exclusion
                        // '特休'/'婚假' 不算在每日休假人數統計中 (0.0)
                    } else {
                        // 檢查是否是半天工作班次
                        const isHalfDayWork = shifts.some(s => HALF_DAY_SHIFTS.includes(s));
                        
                        if (isHalfDayWork) {
                            totalRestCount += 0.5; // 半天工作算 0.5 天休假 (休假人數)
                        }
                        // 全天工作: +0.0
                    }
                });
                dailyRestCounts[dateKey] = totalRestCount;
            });

            // 2. 產生表格內容 (分組排序)
            const staffWithGroups = staffList.map(name => ({
                name: name,
                group: staffDataMap[name]?.group || '輪班人員',
                sortIndex: GROUP_ORDER.indexOf(staffDataMap[name]?.group || '輪班人員')
            }));

            staffWithGroups.sort((a, b) => {
                // 1. Sort by Group Order
                if (a.sortIndex !== b.sortIndex) {
                    return a.sortIndex - b.sortIndex;
                }
                
                // 2. Custom Order for Leaders (莉娟, 麗雯, 佩君)
                if (a.group === '領導組' && b.group === '領導組') {
                    return LEADER_NAMES.indexOf(a.name) - LEADER_NAMES.indexOf(b.name);
                }

                // 3. Alphabetical fallback (for other groups, like '輪班人員')
                const nameA = a.name || '';
                const nameB = b.name || '';
                return nameA.localeCompare(nameB, 'zh-TW');
            });
            
            const baseHours = parseFloat(document.getElementById('monthlyStandardHours').value) || 0; 
            
            let bodyHtml = ''; // Initialize empty bodyHtml (will add rest row later)
            staffWithGroups.forEach(({name, group}) => {
                const staffEntry = staffStats[name];
                // 防禦性檢查：如果 staffEntry 未定義，跳過此行
                if (!staffEntry) {
                    console.warn(`[renderSchedule] Missing staff data for ${name}. Skipping row.`);
                    return; 
                }

                let row = `<tr class="hover:bg-gray-50 transition duration-100">`;
                
                let groupTag = '';
                if (group === '領導組') groupTag = ' | 領';
                if (group === '正常班組') groupTag = ' | 正'; 
                if (group === '服務台組') groupTag = ' | 服';
                if (group === '轉診中心組') groupTag = ' | 華';

                // Col 1: Name (Sticky)
                row += `<td class="sticky sticky-col sticky-col-1 bg-white font-medium text-gray-900 border-r">${name}<span class="text-xs text-gray-500">${groupTag}</span></td>`;
                
                // Col 2: AL Balance (Sticky)
                const annualLeaveHours = staffEntry.annualLeaveDays * HOURS_PER_ANNUAL_LEAVE_DAY;
                row += `<td class="sticky sticky-col sticky-col-2 bg-gray-50 font-mono text-gray-700">${annualLeaveHours.toFixed(1)}</td>`;
                
                // Col 3: Final Settlement (Sticky)
                const finalSettlementHours = staffEntry.settlementHours; // Use the final calculated value
                const finalSettlementClass = finalSettlementHours > 5 ? 'text-red-600 font-bold' : (finalSettlementHours < -5 ? 'text-green-600 font-bold' : 'text-gray-700');
                row += `<td class="sticky sticky-col sticky-col-3 bg-gray-50 font-mono ${finalSettlementClass}">${finalSettlementHours.toFixed(1)}</td>`;

                sortedDates.forEach(item => {
                    // FIX: 使用 ISO Key 查找 schedule
                    const shiftData = staffEntry.schedule[item.dateISO];
                    // FIX: 顯示 shiftData.shift (原始字串, 包含逗號)
                    const shift = shiftData ? shiftData.shift : restShiftName;
                    const isRestDay = shift === restShiftName;
                    const isAnnualLeave = shift === ANNUAL_LEAVE_SHIFT; // NEW check
                    const isWeddingLeave = shift === WEDDING_LEAVE_SHIFT; // NEW check
                    const isFixedRotation = shiftData?.isFixedRotation;
                    // FIX: 預排檢查使用 ISO Key
                    const isManualPreAssigned = shiftData?.preAssigned;

                    // 移除 dayTypeClass
                    let cellClass = '';
                    
                    if (isWeddingLeave) { 
                        cellClass = 'wedding-leave-text'; // NEW: Use wedding leave style
                    } else if (isAnnualLeave) { 
                        cellClass = 'annual-leave-text'; // Use neutral style
                    } else if (isRestDay) { 
                        cellClass = 'rest-day-text'; // Use neutral style
                    }
                    
                    // 固定排班或手動鎖定優先
                    if (isFixedRotation) { cellClass = 'fixed-rotation-text'; } // Use neutral style
                    else if (isManualPreAssigned) { cellClass = 'pre-assigned-text'; } // Use neutral style
                    
                    row += `<td class="${cellClass} border-r border-gray-100">${shift}</td>`;
                });

                // =========================================================================
                // FIXED COLUMNS ON THE RIGHT (R1: 休假天數(休), R2: 超額工時)
                // =========================================================================
                
                // R1: 休假天數 (休 ONLY)
                const restCountClass = staffEntry.restCount > (sortedDates.length / staffList.length) + 1 ? 'text-red-600 font-bold' : 'text-gray-700';
                row += `<td class="font-bold text-lg ${restCountClass} bg-blue-50/70 sticky-col-r1">${staffEntry.restCount.toFixed(1)}</td>`; 
                
                // R2: 超額工時
                const totalHours = (staffEntry.totalWorkMinutes / 60);
                const excessHours = (totalHours - baseHours).toFixed(1);
                const excessClass = excessHours > 0.1 ? 'text-red-600' : 'text-primary'; // Highlight if positive excess
                
                row += `<td class="font-bold text-lg ${excessClass} bg-blue-50/70 sticky-col-excess">${excessHours}</td>`;
                
                row += '</tr>';
                bodyHtml += row;
            });

            // 4. Generate Daily Rest Row (新需求 - 放在底部)
            let restCountRow = `<tr class="bg-yellow-100/70 text-gray-800 font-bold border-t-2 border-gray-400">`;
            // Col 1: Name (Sticky)
            restCountRow += `<td class="sticky sticky-col sticky-col-1 bg-yellow-100/70 font-bold text-base">每日總休假人數</td>`;
            // Col 2-3: Placeholder (Sticky)
            restCountRow += `<td class="sticky sticky-col sticky-col-2 bg-yellow-100/70 font-mono text-xs"></td>`; 
            restCountRow += `<td class="sticky sticky-col sticky-col-3 bg-yellow-100/70 font-mono text-xs"></td>`;

            // Date cells
            sortedDates.forEach(item => {
                const dateKey = item.dateISO;
                const count = dailyRestCounts[dateKey];
                const restClass = count > 0.5 ? 'text-green-700 font-extrabold' : 'text-gray-400'; // Only highlight if > 0.5
                restCountRow += `<td class="${restClass} text-base">${count.toFixed(1)}</td>`;
            });

            // Stats columns (placeholders) - Only need 2 placeholders now
            restCountRow += `<td class="bg-yellow-100/70 border-l-2 border-gray-400 sticky-col-r1"></td>`; // R1 (Total Rest)
            restCountRow += `<td class="bg-yellow-100/70 border-l-2 border-gray-400 sticky-col-excess"></td>`; // R2 (Excess Hours)
            restCountRow += '</tr>';
            
            bodyHtml += restCountRow; // Append to bottom
            body.innerHTML = bodyHtml;

            // 5. 產生統計資訊 (包含婚假)
            let stats = staffList.map(name => {
                const entry = staffStats[name];
                // ONLY include rest and annual leave for the overall comparison stat
                return entry ? (entry.restCount + entry.annualLeaveCount) : 0; 
            });
            
            const minRest = stats.length > 0 ? Math.min(...stats) : 0;
            const maxRest = stats.length > 0 ? Math.max(...stats) : 0;
            const totalDays = datesWithTypes.length;

            summaryStats.innerHTML = `
                <h3 class="font-bold text-lg mb-2">排班統計</h3>
                <p>總排班天數: <span class="font-mono">${totalDays}</span> 天</p>
                <p>總人數: <span class="font-mono">${staffList.length}</span> 人</p>
                <p>休假天數分配範圍 (休+特休): <span class="font-mono text-gray-700">${minRest}</span> 次 (最少) ~ <span class="font-mono text-gray-700">${maxRest}</span> 次 (最多)</p>
                <p class="mt-2 font-semibold ${maxRest - minRest > 1 ? 'text-red-700' : 'text-green-700'}">
                    差異度: ${maxRest - minRest} 次。休假分配非常 <span class="underline">${maxRest - minRest <= 1 ? '平均' : '不平均'}</span>。
                </p>
                <p class="mt-2 text-sm font-semibold text-gray-700">✅ **所有勞基法與固定班表約束已套用。**</p>
            `;

            output.classList.remove('hidden');
        };

        
        // --- NEW SECTION 4.1 Rendering Function ---
        window.renderShiftBreakdownSummary = (staffStats, totalShiftCounts) => {
            const shiftSummaryDiv = document.getElementById('shiftSummary');
            if (!shiftSummaryDiv) return;

            // 1. Generate Staff Rest Stats (for section 4.1 display)
            // Calculate total effective leave count (excluding wedding leave) for comparison
            const effectiveLeaves = staffList.map(name => (staffStats[name]?.restCount || 0) + (staffStats[name]?.annualLeaveCount || 0));
            const minRest = effectiveLeaves.length > 0 ? Math.min(...effectiveLeaves) : 0;
            const maxRest = effectiveLeaves.length > 0 ? Math.max(...effectiveLeaves) : 0;
            
            const staffRestStats = staffList
                .map(name => {
                    const entry = staffStats[name];
                    return {
                        name: name,
                        group: staffDataMap[name]?.group || '輪班人員',
                        rest: entry.restCount || 0,
                        annual: entry.annualLeaveCount || 0,
                        wedding: entry.weddingLeaveCount || 0, // NEW
                        // totalDisplay: for actual combined display (休 + 特休 + 婚假)
                        totalDisplay: (entry.restCount || 0) + (entry.annualLeaveCount || 0) + (entry.weddingLeaveCount || 0), 
                        // effectiveTotal: for comparison/sorting (休 + 特休 ONLY)
                        effectiveTotal: (entry.restCount || 0) + (entry.annualLeaveCount || 0) 
                    };
                }).sort((a, b) => {
                    if (a.group !== b.group) {
                        return GROUP_ORDER.indexOf(a.group) - GROUP_ORDER.indexOf(b.group);
                    }
                    return a.effectiveTotal - b.effectiveTotal; // Sort by effective total
                });
            
            // 2. Start HTML Generation for 4.1
            let summaryHtml = '<h3 class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">4.1 總工作班次分配概覽 (點擊查看明細)</h3>';
            
            if (staffRestStats.length > 0) {
                // Staff Rest Overview (moved from renderSchedule to here for 4.1)
                summaryHtml += '<div class="mb-6 p-4 bg-white rounded-lg shadow-inner border border-blue-200">';
                // 移除標題中的 /婚假
                summaryHtml += '<h4 class="font-bold text-blue-700 mb-2">人員休假總覽（休+特休）</h4>'; 
                summaryHtml += '<div class="grid grid-cols-2 sm:grid-cols-3 gap-y-2 text-xs">';
                
                staffRestStats.forEach(item => {
                    const isRotation = item.group === '輪班人員';
                    const nameClass = isRotation ? 'text-gray-700' : 'font-semibold text-indigo-800';
                    // Use effectiveTotal for highlight comparison
                    const isMin = item.effectiveTotal === minRest;
                    const isMax = item.effectiveTotal === maxRest;
                    const totalDaysClass = isMin || isMax ? 'font-bold text-red-600' : 'text-gray-600';

                    
                    summaryHtml += `
                        <div class="flex justify-between pr-2 border-r border-gray-100">
                            <span class="${nameClass} truncate mr-2">${item.name}</span>
                            <span class="${totalDaysClass} font-mono">${item.totalDisplay.toFixed(0)} <span class="text-xs font-normal text-gray-500">(休:${item.rest.toFixed(0)}/特:${item.annual.toFixed(0)}/婚:${item.wedding.toFixed(0)})</span></span>
                        </div>
                    `;
                });
                summaryHtml += '</div>';
                summaryHtml += '</div>';
            }

            // Shift Count Statistics (Original Section 4.1 breakdown)
            const sortedShifts = Object.entries(totalShiftCounts)
                .sort(([shiftA], [shiftB]) => {
                    return shiftA.localeCompare(shiftB, 'zh-TW');
                });
            
            if (sortedShifts.length > 0) {
                summaryHtml += '<h4 class="font-bold text-gray-700 mb-2 mt-4 border-t pt-2">工作班次總數 (點擊查看明細)</h4>';
                summaryHtml += '<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 text-sm">';
                sortedShifts.forEach(([shiftName, count]) => {
                    // Look up time info from any of the requirement types
                    const timeInfo = Object.values(requirements).map(req => req[shiftName]?.timeSlot).filter(t => t)[0] || 'N/A';
                    const restingMinutes = Object.values(requirements).map(req => req[shiftName]?.restingMinutes).filter(r => r !== undefined)[0] || 0;
                    
                    // ADD onclick event to trigger breakdown modal
                    summaryHtml += `
                        <div onclick="window.showShiftBreakdown('${shiftName}')" 
                            class="cursor-pointer transition duration-150 transform hover:scale-[1.03] hover:shadow-lg bg-white p-3 rounded-xl border border-gray-200 shadow-md flex flex-col justify-between h-full">
                            <p class="font-bold text-primary">${shiftName}</p>
                            <p class="text-xs text-gray-500 mt-1">${timeInfo} (休: ${restingMinutes}分)</p>
                            <p class="mt-2 text-2xl font-extrabold text-teal-700">${count} <span class="text-base font-semibold">次</span></p>
                            <p class="text-xs text-gray-400 mt-1">點擊查看人員明細</p>
                        </div>
                    `;
                });
                summaryHtml += '</div>';
                summaryHtml += '</div>';
            } else if (staffList.length > 0) {
                summaryHtml += '<p class="text-xs text-green-600 font-medium italic mt-4">✅ 無輪班人員所需的工作班次。</p>';
            } else {
                summaryHtml += '<p class="text-gray-500 italic">無工作班次數據可供顯示。</p>';
            }

            shiftSummaryDiv.innerHTML = summaryHtml;
        };


        // --- NEW SECTION 4.3 Rendering Function ---
        window.renderBalanceBreakdownSummary = (staffStats) => {
            const container = document.getElementById('balanceBreakdownSummary');
            if (!container) return;

            // 1. Filter and sort Rotation Staff
            const rotationStaffStats = staffList
                .filter(name => staffDataMap[name]?.group === '輪班人員')
                .map(name => ({
                    name: name,
                    group: staffDataMap[name]?.group,
                    satRest: staffStats[name].satRestCount || 0,
                    sunHolRest: staffStats[name].sunRestCount || 0, // Now only actual Sunday rest count
                    totalLate: staffStats[name].totalLateShifts || 0,
                    satLate: staffStats[name].satLateShifts || 0,
                    sunHolLate: staffStats[name].sunHolLateShifts || 0,
                }))
                .sort((a, b) => {
                    // Primary sort: Total Rest (Sat + Sun)
                    const totalRestA = a.satRest + a.sunHolRest;
                    const totalRestB = b.satRest + b.sunHolRest;
                    if (totalRestA !== totalRestB) return totalRestB - totalRestA; // Descending (more rest first)

                    // Secondary sort: Total Late Shifts
                    if (a.totalLate !== b.totalLate) return a.totalLate - b.totalLate;

                    return a.name.localeCompare(b.name, 'zh-TW'); // Alphabetical fallback
                });

            if (rotationStaffStats.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-500 italic mt-4">無輪班人員數據可供分析。</p>';
                return;
            }
            
            // 2. Calculate balance ranges for highlighting
            const satRestTotals = rotationStaffStats.map(s => s.satRest);
            const sunHolRestTotals = rotationStaffStats.map(s => s.sunHolRest);
            const totalLateTotals = rotationStaffStats.map(s => s.totalLate);
            
            const minSatRest = satRestTotals.length > 0 ? Math.min(...satRestTotals) : 0;
            const maxSatRest = satRestTotals.length > 0 ? Math.max(...satRestTotals) : 0;
            const minSunHolRest = sunHolRestTotals.length > 0 ? Math.min(...sunHolRestTotals) : 0;
            const maxSunHolRest = sunHolRestTotals.length > 0 ? Math.max(...sunHolRestTotals) : 0;
            const minTotalLate = totalLateTotals.length > 0 ? Math.min(...totalLateTotals) : 0;
            const maxTotalLate = totalLateTotals.length > 0 ? Math.max(...totalLateTotals) : 0;

            // 3. Build HTML
            let html = `
                <h3 class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">4.3 週末及小夜班次分配明細 (僅輪班人員)</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4 text-xs font-semibold">
                    <div class="p-3 rounded-lg bg-green-50 border border-green-200">
                        <p class="text-green-800 mb-1">周六休假平衡:</p>
                        <p class="font-mono">${minSatRest} ~ ${maxSatRest} 次 (<span class="${maxSatRest - minSatRest > 1 ? 'text-red-600' : 'text-green-600'}">差異: ${maxSatRest - minSatRest}</span>)</p>
                    </div>
                    <div class="p-3 rounded-lg bg-green-50 border border-green-200">
                        <p class="text-green-800 mb-1">實際周日休假平衡:</p>
                        <p class="font-mono">${minSunHolRest} ~ ${maxSunHolRest} 次 (<span class="${maxSunHolRest - minSunHolRest > 1 ? 'text-red-600' : 'text-green-600'}">差異: ${maxSunHolRest - minSunHolRest}</span>)</p>
                    </div>
                    <div class="p-3 rounded-lg bg-indigo-50 border border-indigo-200">
                        <p class="text-indigo-800 mb-1">總小夜班平衡:</p>
                        <p class="font-mono">${minTotalLate} ~ ${maxTotalLate} 次 (<span class="${maxTotalLate - minTotalLate > 1 ? 'text-red-600' : 'text-green-600'}">差異: ${maxTotalLate - minTotalLate}</span>)</p>
                    </div>
                </div>

                <div class="table-container bg-white rounded-lg shadow-md border border-gray-200">
                    <table class="schedule-table w-full text-xs">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="sticky left-0 z-30 min-w-[80px] bg-gray-100 text-left pl-3">人員</th>
                                <th class="min-w-[60px]">周六休假</th>
                                <th class="min-w-[60px]">周日休假 (實際)</th>
                                <th class="min-w-[70px]">總小夜次數</th>
                                <th class="min-w-[60px]">周六小夜</th>
                                <th class="min-w-[60px]">周日/假小夜</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            rotationStaffStats.forEach(staff => {
                const satRestClass = staff.satRest === minSatRest && minSatRest !== maxSatRest ? 'text-green-700 font-bold' : (staff.satRest === maxSatRest && minSatRest !== maxSatRest ? 'text-red-700 font-bold' : 'text-gray-700');
                const sunHolRestClass = staff.sunHolRest === minSunHolRest && minSunHolRest !== maxSunHolRest ? 'text-green-700 font-bold' : (staff.sunHolRest === maxSunHolRest && minSunHolRest !== maxSunHolRest ? 'text-red-700 font-bold' : 'text-gray-700');
                const totalLateClass = staff.totalLate === minTotalLate && minTotalLate !== maxTotalLate ? 'text-green-700 font-bold' : (staff.totalLate === maxTotalLate && minTotalLate !== maxTotalLate ? 'text-red-700 font-bold' : 'text-primary');

                html += `
                    <tr class="hover:bg-gray-50 transition duration-100">
                        <td class="sticky left-0 z-30 bg-white font-medium text-left pl-3">${staff.name}</td>
                        <td class="${satRestClass}">${staff.satRest}</td>
                        <td class="${sunHolRestClass}">${staff.sunHolRest}</td>
                        <td class="${totalLateClass} font-mono font-bold">${staff.totalLate}</td>
                        <td class="text-gray-700">${staff.satLate}</td>
                        <td class="text-gray-700">${staff.sunHolLate}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        };

        /**
         * NEW: 渲染小夜班次平衡總覽到 4.2 區塊
         */
        window.renderLateShiftSummary = (staffStats) => {
            const container = document.getElementById('lateShiftSummary');
            if (!container) return;

            // 只篩選輪班人員的數據
            const rotationStaffStats = staffList
                .filter(name => staffDataMap[name]?.group === '輪班人員')
                .map(name => ({
                    name: name,
                    totalLate: staffStats[name].totalLateShifts || 0,
                    satLate: staffStats[name].satLateShifts || 0,
                    sunHolLate: staffStats[name].sunHolLateShifts || 0,
                }))
                .sort((a, b) => {
                    // Primary sort: Total Late Shifts (ascending for balancing check)
                    if (a.totalLate !== b.totalLate) return a.totalLate - b.totalLate;
                    // Secondary sort: Alphabetical
                    return a.name.localeCompare(b.name, 'zh-TW');
                });

            if (rotationStaffStats.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-500 italic mt-4">無輪班人員數據可供分析。</p>';
                return;
            }
            
            // Calculate overall max/min for balancing highlight
            const allTotals = rotationStaffStats.map(s => s.totalLate);
            const minTotal = allTotals.length > 0 ? Math.min(...allTotals) : 0;
            const maxTotal = allTotals.length > 0 ? Math.max(...allTotals) : 0;
            const diff = maxTotal - minTotal;
            
            let html = `
                <h3 class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">4.2 小夜班次總覽 (輪班人員)</h3>
                
                <p class="text-sm text-gray-500 mb-2">詳細的週末及小夜班次明細，請參考 **4.3 區塊**。</p>
                
                <div class="bg-indigo-50 p-4 rounded-lg shadow-inner border border-indigo-200 mb-4">
                    <p class="font-bold text-sm text-indigo-800 mb-1">總平衡狀況：</p>
                    <p class="text-xs text-indigo-700">輪班人員小夜總次數範圍：<span class="font-mono font-bold">${minTotal}</span> 次 (最少) ~ <span class="font-mono font-bold">${maxTotal}</span> 次 (最多)</p>
                    <p class="text-sm font-bold mt-1 ${diff > 1 ? 'text-red-700' : 'text-green-700'}">
                        次數差異度：${diff} 次。分配非常 <span class="underline">${diff <= 1 ? '平均' : '不平均'}</span>。
                    </p>
                </div>
            `;

            container.innerHTML = html;
        };

        /**
         * NEW MODAL FUNCTIONS (kept as is)
         */
        function openModal() {
            document.getElementById('shiftModal').classList.remove('hidden');
        }

        window.closeModal = () => {
            document.getElementById('shiftModal').classList.add('hidden');
        };

        window.showShiftBreakdown = (shiftName) => {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');

            // 1. Generate breakdown data
            const breakdown = staffList.map(name => {
                // Ensure we check for multi-shifts correctly if needed, but for total count, staffStats.shifts is fine.
                const count = window.staffStats[name]?.shifts[shiftName] || 0;
                return { name, count };
            }).filter(item => item.count > 0).sort((a, b) => {
                // Sort descending by count, then by group, then alphabetically
                if (b.count !== a.count) return b.count - a.count;
                
                const groupA = staffDataMap[a.name]?.group || '輪班人員';
                const groupB = staffDataMap[b.name]?.group || '輪班人員';
                
                const indexA = GROUP_ORDER.indexOf(groupA);
                const indexB = GROUP_ORDER.indexOf(groupB);
                
                if (indexA !== indexB) return indexA - indexB; // Fixed/Leader groups first
                
                return a.name.localeCompare(b.name, 'zh-TW'); // Alphabetical fallback
            });

            // 2. Set modal content
            modalTitle.textContent = `班別「${shiftName}」的分配明細`;

            if (breakdown.length === 0) {
                modalContent.innerHTML = '<p class="text-gray-500 p-4 text-center">查無人員分配此班別。</p>';
            } else {
                let contentHtml = '<ul class="divide-y divide-gray-100 p-4">';
                breakdown.forEach(item => {
                    const group = staffDataMap[item.name]?.group || '輪班人員';
                    const isHighlighted = group !== '輪班人員' ? 'font-bold text-blue-700' : 'text-gray-800';
                    const groupTag = (group === '輪班人員') ? '輪班' : group.charAt(0);
                    const tagClass = group === '領導組' || group === '正常班組' ? 'bg-indigo-100' : 'bg-gray-100';

                    contentHtml += `
                        <li class="flex justify-between items-center py-2 px-1">
                            <span class="${isHighlighted} text-sm w-1/2 truncate">
                                ${item.name} 
                                <span class="text-xs text-gray-500 px-1 rounded ${tagClass}">(${groupTag})</span>
                            </span>
                            <span class="text-lg font-mono font-extrabold text-teal-700">${item.count} <span class="text-base font-semibold">次</span></span>
                        </li>
                    `;
                });
                contentHtml += '</ul>';
                modalContent.innerHTML = contentHtml;
            }

            // 3. Open modal
            openModal();
        };

        window.exportToCSV = (showSuccessMessage = true) => {
            // 檢查是否有數據，但由於現在由 generateSchedule() 呼叫，所以理論上會有數據。
            if (Object.keys(window.staffStats).length === 0 || staffList.length === 0 || datesWithTypes.length === 0) {
                if (showSuccessMessage) {
                    window.showMessage('❌ 無班表數據可供匯出。請先點擊「一鍵生成平衡班表」按鈕。', 'error');
                }
                console.warn("CSV Export Failed: No schedule data found. Please run generateSchedule() first.");
                return;
            }
            
            // 重新計算 sortedDates (確保 dateObj 存在)
            const sortedDates = datesWithTypes.map(item => ({
                dateISO: item.dateObj.toISOString().split('T')[0],
                dateStr: window.formatDate(item.dateObj), 
                type: item.type
            }));
            
            let csvContent = "\ufeff"; // BOM for proper Chinese character display

            // 調整 CSV Header (將統計欄位移到日期之後)
            let header = [
                '人員/日期', 
                '所屬組別', 
                '最終特休結餘 (小時)', 
                '最終結算時數 (小時)',
            ];
            
            // 日期表頭
            sortedDates.forEach(item => {
                header.push(item.dateStr + ' (' + window.getTypeLabel(item.type) + ')');
            });
            
            // 統計欄位 (保持完整匯出)
            header.push('休假天數 (休)'); 
            header.push('周六休假'); 
            header.push('周日/假休假'); 
            header.push('總小夜次數');
            header.push('周六小夜次數');
            header.push('周日/假小夜次數');
            header.push('超額工時 (小時)'); // LAST
            
            csvContent += header.join(',') + '\n';

            const baseHours = parseFloat(document.getElementById('monthlyStandardHours').value) || 0; 
            const LEAVE_SHIFTS = [restShiftName, ANNUAL_LEAVE_SHIFT, WEDDING_LEAVE_SHIFT]; // NEW

            staffList.forEach(name => {
                const staffEntry = window.staffStats[name];
                // 防禦性檢查：如果 staffEntry 未定義，跳過此行
                if (!staffEntry) {
                    console.error(`[exportToCSV] Missing staff data for: ${name}. Skipping row.`);
                    return; 
                }

                const group = staffDataMap[name]?.group || '輪班人員';
                
                // NEW: Calculate Excess Hours
                const totalHours = (staffEntry.totalWorkMinutes / 60);
                const excessHours = (totalHours - baseHours).toFixed(1);
                
                let row = [
                    name, 
                    `"${group}"`,
                    // 特休結餘：天數轉換為小時
                    (staffEntry.annualLeaveDays * HOURS_PER_ANNUAL_LEAVE_DAY).toFixed(1), 
                    // 最終結算時數
                    staffEntry.settlementHours.toFixed(1), 
                ];
                
                // Schedule data
                sortedDates.forEach(item => {
                    // FIX: 使用 ISO Key 查找 schedule
                    const shiftData = staffEntry.schedule[item.dateISO];
                    const shift = shiftData ? shiftData.shift : restShiftName;
                    row.push(`"${shift}"`); 
                });

                
                // NEW stats push (at the end of the schedule)
                row.push(staffEntry.restCount.toFixed(1)); // 休假天數 (休)
                row.push(staffEntry.satRestCount); 
                row.push(staffEntry.sunRestCount); 
                row.push(staffEntry.totalLateShifts);
                row.push(staffEntry.satLateShifts);
                row.push(staffEntry.sunHolLateShifts);
                row.push(excessHours); // 超額工時
                
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            
            const firstDate = datesWithTypes[0].dateObj;
            const yearMonth = firstDate.getFullYear() + String(firstDate.getMonth() + 1).padStart(2, '0');
            const fileName = `排班表_${yearMonth}.csv`;
            
            link.setAttribute('download', fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`CSV export triggered successfully for file: ${fileName}`);

            if (showSuccessMessage) {
                window.updateSaveStatus('✅ 班表已匯出為 CSV 檔案。', 'success');
            }
        };
        
        window.populateShiftDatalist = () => {
            const select = document.getElementById('manualShift');
            if (!select) return;

            // Gather all unique shift names
            let allShifts = new Set();
            ['Clinic_MWTH', 'Clinic_TF', 'Saturday', 'SundayHoliday'].forEach(type => {
                // 排除休假、特休和婚假，因為它們是硬編碼添加
                Object.keys(requirements[type]).filter(name => name !== restShiftName && name !== ANNUAL_LEAVE_SHIFT && name !== WEDDING_LEAVE_SHIFT).forEach(shiftName => {
                    if (shiftName && shiftName.trim() !== '') {
                        allShifts.add(shiftName);
                    }
                });
            });
            
            // Add mandatory leave shifts
            allShifts.add(restShiftName);
            allShifts.add(ANNUAL_LEAVE_SHIFT);
            allShifts.add(WEDDING_LEAVE_SHIFT); // NEW: Add Wedding Leave
            
            // Sort shifts alphabetically (休假/特休/婚假優先)
            const sortedShifts = Array.from(allShifts).sort((a, b) => {
                const isLeaveA = [restShiftName, ANNUAL_LEAVE_SHIFT, WEDDING_LEAVE_SHIFT].includes(a);
                const isLeaveB = [restShiftName, ANNUAL_LEAVE_SHIFT, WEDDING_LEAVE_SHIFT].includes(b);

                if (isLeaveA && !isLeaveB) return -1;
                if (!isLeaveA && isLeaveB) return 1;
                
                // Within leave shifts, sort alphabetically
                if (isLeaveA && isLeaveB) return a.localeCompare(b);

                return a.localeCompare(b);
            });
            
            const currentSelected = select.value;
            
            let options = '<option value="">-- 請選擇 --</option>';
            options += sortedShifts.map(shift => `<option value="${shift}" ${shift === currentSelected ? 'selected' : ''}>${shift}</option>`).join('');

            select.innerHTML = options;
        };

        // RENAME: populateManualInputs -> populateAllDropdowns
        window.populateAllDropdowns = () => {
            // Section 1.3 (組別選擇)
            const sdSelect = document.getElementById('serviceDeskStaffSelect');
            const rcSelect = document.getElementById('referralCenterStaffSelect');
            const regStaff1Select = document.getElementById('regStaff1Select'); 
            const regStaff2Select = document.getElementById('regStaff2Select'); 
            
            // NEW: Previous month SD/RC Selects
            const prevSdSelect = document.getElementById('prevSdStaffSelect');
            const prevRcSelect = document.getElementById('prevRcStaffSelect');


            // 儲存當前選取值
            const currentSD = sdSelect.value;
            const currentRC = rcSelect.value;
            const currentReg1 = regStaff1Select.value; 
            const currentReg2 = regStaff2Select.value; 
            const currentPrevSD = prevSdSelect.value; 
            const currentPrevRC = prevRcSelect.value; 
            
            // NEW: Get manual input values
            const currentManualStaff = document.getElementById('manualStaff').value;
            const currentManualDate = document.getElementById('manualDate').value;
            
            const staffOptions = staffList.map(name => `<option value="${name}">${name}</option>`).join('');
            const defaultOption = '<option value="">(未選取)</option>';
            
            // 填充人員選擇器
            document.getElementById('manualStaff').innerHTML = defaultOption + staffOptions;
            
            sdSelect.innerHTML = defaultOption + staffOptions;
            rcSelect.innerHTML = defaultOption + staffOptions;
            regStaff1Select.innerHTML = defaultOption + staffOptions; 
            regStaff2Select.innerHTML = defaultOption + staffOptions; 
            
            prevSdSelect.innerHTML = defaultOption + staffOptions; 
            prevRcSelect.innerHTML = defaultOption + staffOptions; 

            // 恢復選取值
            sdSelect.value = staffList.includes(currentSD) ? currentSD : '';
            rcSelect.value = staffList.includes(currentRC) ? currentRC : '';
            regStaff1Select.value = staffList.includes(currentReg1) ? currentReg1 : ''; 
            regStaff2Select.value = staffList.includes(currentReg2) ? currentReg2 : ''; 
            prevSdSelect.value = staffList.includes(currentPrevSD) ? currentPrevSD : ''; 
            prevRcSelect.value = staffList.includes(currentPrevRC) ? currentPrevRC : ''; 

            // NEW: 恢復手動鎖定的人員選取
            document.getElementById('manualStaff').value = staffList.includes(currentManualStaff) ? currentManualStaff : '';

            if (staffList.length === 0) {
                document.getElementById('manualStaff').innerHTML = '<option value="">請先輸入人員</option>';
                sdSelect.innerHTML = '<option value="">請先輸入人員</option>';
                rcSelect.innerHTML = '<option value="">請先輸入人員</option>';
                regStaff1Select.innerHTML = '<option value="">請先輸入人員</option>'; 
                regStaff2Select.innerHTML = '<option value="">請先輸入人員</option>'; 
                prevSdSelect.innerHTML = '<option value="">請先輸入人員</option>'; 
                prevRcSelect.innerHTML = '<option value="">請先輸入人員</option>'; 
            }

            // 填充日期 (所有日期選擇器共用)
            const dateOptions = datesWithTypes.map(item => {
                const dateKey = item.dateObj.toISOString().split('T')[0];
                const displayStr = window.formatDate(item.dateObj);
                return `<option value="${dateKey}">${displayStr} (${window.getTypeLabel(item.type)})</option>`;
            }).join('');

            document.getElementById('manualDate').innerHTML = dateOptions;

            if (datesWithTypes.length === 0) {
                document.getElementById('manualDate').innerHTML = '<option value="">請先新增日期</option>';
            } else {
                // NEW: 恢復手動鎖定的日期選取
                const isValidDate = datesWithTypes.some(item => item.dateObj.toISOString().split('T')[0] === currentManualDate);
                // Set value: if valid, use current, otherwise use the first date available.
                document.getElementById('manualDate').value = isValidDate 
                    ? currentManualDate 
                    : datesWithTypes[0].dateObj.toISOString().split('T')[0];
            }

            // Call new render functions
            window.renderCarryOverInputs();
            window.renderAnnualLeaveInputs();
            window.renderSettlementHoursInputs();
        };

        
        /**
         * 鎖定工作班別 (Section 3.2)
         */
        window.addManualShift = () => {
            const staffName = document.getElementById('manualStaff').value;
            const dateISO = document.getElementById('manualDate').value;
            const shiftName = document.getElementById('manualShift').value.trim(); // Reads from select value now
            
            if (!staffName || !dateISO || !shiftName) { window.showMessage('❌ 請填寫所有手動鎖定欄位。', 'error'); return; }

            // FIX: 使用 getDateObjFromISOKey 取得穩定的日期物件，用於顯示
            const dateObj = getDateObjFromISOKey(dateISO);
            
            if (!dateObj) {
                 window.showMessage(`❌ 內部錯誤：找不到日期 ${dateISO} 的物件。`, 'error'); 
                 return;
            }
            
            const dateStr = window.formatDate(dateObj); 
            
            if (!preAssignedShifts[staffName]) { preAssignedShifts[staffName] = {}; }
            
            const group = staffDataMap[staffName]?.group || '輪班人員';
            const LEAVE_SHIFTS = [restShiftName, ANNUAL_LEAVE_SHIFT, WEDDING_LEAVE_SHIFT]; // NEW

            
            // 警告邏輯保持不變 (但現在 SD/RC/Reg 的鎖定會被尊重，只對 莉娟/麗雯 發出警告)
            if (group === '領導組' && staffName !== '佩君' && !LEAVE_SHIFTS.includes(shiftName)) {
                 window.showMessage(`⚠️ 員工 ${staffName} (莉娟/麗雯) 屬於領導組。此手動鎖定的**工作班別**將在生成班表時被固定班邏輯覆寫。`, 'warning');
            }


            // FIX: 使用 ISO key
            preAssignedShifts[staffName][dateISO] = shiftName;
            
            // 清除選單（可選）
            document.getElementById('manualShift').value = '';

            window.renderPreAssignedShifts();
            window.renderShiftAvailability();
            window.saveData && window.saveData();
            
            let msgType = LEAVE_SHIFTS.includes(shiftName) ? 'success' : 'info'; // NEW: Check all leave types
            window.showMessage(`✅ 員工 ${staffName} 在 ${dateStr} 的班別/假別已鎖定為「${shiftName}」。`, msgType);
        };

        window.renderPreAssignedShifts = () => {
            // FIX: 確保在渲染前先同步人員數據
            window.parseStaffData(); 

            const listContainer = document.getElementById('preAssignedList');
            const preAssignedNames = Object.keys(preAssignedShifts).filter(name => Object.keys(preAssignedShifts[name]).length > 0);
            const LEAVE_SHIFTS = [restShiftName, ANNUAL_LEAVE_SHIFT, WEDDING_LEAVE_SHIFT]; // NEW

            if (preAssignedNames.length === 0) {
                listContainer.innerHTML = '<p class="text-xs text-gray-500 italic p-1">無預先鎖定班表</p>';
                return;
            }

            // Keep the header and button, only update the content inside the listContainer
            const headerHtml = '<p class="text-sm font-bold text-gray-700 border-b border-gray-300 pb-2 mb-2">已鎖定班表摘要：</p>';
            let listContent = '';

            preAssignedNames.forEach(name => {
                // Ensure the name is still in the staffList
                if (!staffList.includes(name)) return;

                const datesShifts = Object.entries(preAssignedShifts[name]);
                const datesDrawn = datesShifts.length;
                let tag = '';
                const group = staffDataMap[name]?.group || '輪班人員';
                // 使用中性樣式 (粗體/文字顏色)
                if (group === '領導組') tag = ` <span class="font-bold text-gray-700">(領導組)</span>`;
                else if (group === '正常班組') tag = ` <span class="font-bold text-gray-700">(正常班組)</span>`; 
                else if (group === '服務台組') tag = ` <span class="font-bold text-gray-700">(服務台組)</span>`;
                else if (group === '轉診中心組') tag = ` <span class="font-bold text-gray-700">(轉診中心組)</span>`;

                // 收集詳細清單
                const detailList = datesShifts
                    .sort(([dateKeyA], [dateKeyB]) => dateKeyA.localeCompare(dateKeyB)) // 根據 YYYY-MM-DD 排序
                    .map(([dateISO, shiftName]) => {
                        let colorClass; 
                        // 使用灰階和結構區分
                        if (shiftName === ANNUAL_LEAVE_SHIFT) {
                            colorClass = 'text-gray-600 underline'; // 特休，加底線
                        } else if (shiftName === WEDDING_LEAVE_SHIFT) { // NEW: Handle Wedding Leave
                            colorClass = 'text-purple-600 underline'; // 婚假，加底線
                        } else if (shiftName === restShiftName) {
                            colorClass = 'text-gray-600'; // 一般休假
                        } else {
                            colorClass = 'text-gray-900 font-bold'; // 工作班，最突出
                        }
                        
                        // FIX: 從 ISO key 轉換為顯示格式 (MM/DD)
                        const dateObj = getDateObjFromISOKey(dateISO);
                        const shortDate = dateObj ? window.formatDate(dateObj).split(' ')[0] : '無效日期';
                        
                        return `<span class="${colorClass} font-semibold">${shortDate}:${shiftName}</span>`;
                    })
                    .join(' | ');


                listContent += `
                    <div class="mb-2 p-2 border border-gray-300 rounded-md">
                        <p class="font-bold text-sm text-gray-800">${name}${tag}：已鎖定 ${datesDrawn} 天</p>
                        <p class="mt-1 flex flex-wrap gap-x-3 gap-y-1 text-xs">${detailList}</p>
                        <button onclick="window.removeManualShift('${name}', '${datesShifts.map(([dateISO]) => dateISO).join(',')}')" class="text-red-500 text-xs hover:underline">解除此人員鎖定</button>
                    </div>
                `;
            });

            listContainer.innerHTML = headerHtml + listContent + '<button onclick="window.clearPreAssignedShifts()" class="mt-3 text-red-600 text-xs hover:underline">解除所有鎖定</button>';
        };
        
        window.clearPreAssignedShifts = () => {
            preAssignedShifts = {};
            window.renderPreAssignedShifts();
            window.populateAllDropdowns(); // RENAME
            window.renderShiftAvailability();
            window.saveData && window.saveData();
            window.showMessage('所有手動鎖定班表已清除。', 'info');
        };
        
        // NEW: Add function to remove specific staff's manual shifts
        window.removeManualShift = (staffName, dateISOs) => {
            const dateArray = dateISOs.split(',');
            if (preAssignedShifts[staffName]) {
                dateArray.forEach(dateISO => {
                    delete preAssignedShifts[staffName][dateISO];
                });
                if (Object.keys(preAssignedShifts[staffName]).length === 0) {
                    delete preAssignedShifts[staffName];
                }
            }
            window.renderPreAssignedShifts();
            window.renderShiftAvailability();
            window.saveData && window.saveData();
            window.showMessage(`已清除 ${staffName} 的 ${dateArray.length} 個手動鎖定班表。`, 'info');
        };


        // --- 預設數據初始化 ---

        window.initDefaultData = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
            
            const defaultDate = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
            document.getElementById('singleDateInput').value = defaultDate;
            document.getElementById('monthStartInput').value = defaultDate;

            // 變更: 預設為當月 1 號
            const rotationStart = new Date(year, month, 1);
            const rotationStartStr = rotationStart.getFullYear() + '-' + String(rotationStart.getMonth() + 1).padStart(2, '0') + '-' + String(rotationStart.getDate()).padStart(2, '0');
            document.getElementById('rotationStartDate').value = rotationStartStr;

            window.generateMonthlyDates(today, lastDayOfMonth);
            
            // 預設班別需求 (根據使用者要求調整休息時間)
            requirements = {
                Clinic_MWTH: {
                    'D△': { count: 1, timeSlot: '08:00-16:30', restingMinutes: 30, timeMeta: parseShiftTime('08:00-16:30') },
                    'E△': { count: 1, timeSlot: '15:30-00:00', restingMinutes: 30, timeMeta: parseShiftTime('15:30-00:00') }, 
                    'N': { count: 1, timeSlot: '00:00-08:30', restingMinutes: 30, timeMeta: parseShiftTime('00:00-08:30') },
                    'E6': { count: 1, timeSlot: '15:30-00:00', restingMinutes: 30, timeMeta: parseShiftTime('15:30-00:00') }, 
                    'D6': { count: 1, timeSlot: '08:00-16:30', restingMinutes: 30, timeMeta: parseShiftTime('08:00-16:30') },
                    'W7': { count: 1, timeSlot: '15:30-22:00', restingMinutes: 30, timeMeta: parseShiftTime('15:30-22:00') },
                    'A3': { count: 1, timeSlot: '09:00-17:30', restingMinutes: 30, timeMeta: parseShiftTime('09:00-17:30') },
                    'S2': { count: 1, timeSlot: '12:00-20:30', restingMinutes: 30, timeMeta: parseShiftTime('12:00-20:30') },
                    'D1(5)': { count: 1, timeSlot: '08:00-12:00', restingMinutes: 0, timeMeta: parseShiftTime('08:00-12:00') }, 
                    'CO': { count: 1, timeSlot: '08:00-17:00', restingMinutes: 60, timeMeta: parseShiftTime('08:00-17:00') },
                    'CO*': { count: 1, timeSlot: '08:00-17:00', restingMinutes: 60, timeMeta: parseShiftTime('08:00-17:00') },
                    'F台': { count: 1, timeSlot: '09:00-18:00', restingMinutes: 60, timeMeta: parseShiftTime('09:00-18:00') },
                    'CO台': { count: 1, timeSlot: '08:00-17:00', restingMinutes: 60, timeMeta: parseShiftTime('08:00-17:00') },
                    'D7': { count: 1, timeSlot: '08:00-16:30', restingMinutes: 30, timeMeta: parseShiftTime('08:00-16:30') }, 
                },
                Clinic_TF: { 
                    'D△': { count: 1, timeSlot: '08:00-16:30', restingMinutes: 30, timeMeta: parseShiftTime('08:00-16:30') },
                    'E△': { count: 1, timeSlot: '15:30-00:00', restingMinutes: 30, timeMeta: parseShiftTime('15:30-00:00') }, 
                    'N': { count: 1, timeSlot: '00:00-08:30', restingMinutes: 30, timeMeta: parseShiftTime('00:00-08:30') },
                    'E6': { count: 1, timeSlot: '15:30-00:00', restingMinutes: 30, timeMeta: parseShiftTime('15:30-00:00') }, 
                    'D6': { count: 1, timeSlot: '08:00-16:30', restingMinutes: 30, timeMeta: parseShiftTime('08:00-16:30') },
                    'W7': { count: 1, timeSlot: '15:30-22:00', restingMinutes: 30, timeMeta: parseShiftTime('15:30-22:00') },
                    'A3': { count: 1, timeSlot: '09:00-17:30', restingMinutes: 30, timeMeta: parseShiftTime('09:00-17:30') },
                    'S2': { count: 1, timeSlot: '12:00-20:30', restingMinutes: 30, timeMeta: parseShiftTime('12:00-20:30') },
                    'CO5': { count: 1, timeSlot: '08:00-17:00', restingMinutes: 60, timeMeta: parseShiftTime('08:00-17:00') },
                    'CO': { count: 1, timeSlot: '08:00-17:00', restingMinutes: 60, timeMeta: parseShiftTime('08:00-17:00') },
                    'CO*': { count: 1, timeSlot: '08:00-17:00', restingMinutes: 60, timeMeta: parseShiftTime('08:00-17:00') },
                    'F台': { count: 1, timeSlot: '09:00-18:00', restingMinutes: 60, timeMeta: parseShiftTime('09:00-18:00') },
                    'CO台': { count: 1, timeSlot: '08:00-17:00', restingMinutes: 60, timeMeta: parseShiftTime('08:00-17:00') },
                    'D7': { count: 1, timeSlot: '08:00-16:30', restingMinutes: 30, timeMeta: parseShiftTime('08:00-16:30') }, 
                },
                Saturday: {
                    'D△': { count: 1, timeSlot: '08:00-16:30', restingMinutes: 30, timeMeta: parseShiftTime('08:00-16:30') },
                    'E△': { count: 1, timeSlot: '15:30-00:00', restingMinutes: 30, timeMeta: parseShiftTime('15:30-00:00') }, 
                    'N': { count: 1, timeSlot: '00:00-08:30', restingMinutes: 30, timeMeta: parseShiftTime('00:00-08:30') },
                    'E▲': { count: 1, timeSlot: '15:30-00:00', restingMinutes: 30, timeMeta: parseShiftTime('15:30-00:00') }, 
                    'D6': { count: 1, timeSlot: '08:00-16:30', restingMinutes: 30, timeMeta: parseShiftTime('08:00-16:30') },
                    'Y7': { count: 1, timeSlot: '08:00-14:00', restingMinutes: 30, timeMeta: parseShiftTime('08:00-14:00') },
                    'I3': { count: 1, timeSlot: '09:00-13:00', restingMinutes: 0, timeMeta: parseShiftTime('09:00-13:00') },
                    'D1台': { count: 1, timeSlot: '08:00-12:00', restingMinutes: 0, timeMeta: parseShiftTime('08:00-12:00') },
                },
                SundayHoliday: {
                    'D△': { count: 1, timeSlot: '08:00-16:00', restingMinutes: 30, timeMeta: parseShiftTime('08:00-16:00') },
                    'E△': { count: 1, timeSlot: '16:00-00:00', restingMinutes: 30, timeMeta: parseShiftTime('16:00-00:00') },
                    'N': { count: 1, timeSlot: '00:00-08:00', restingMinutes: 30, timeMeta: parseShiftTime('00:00-08:00') },
                    'E▲': { count: 1, timeSlot: '16:00-00:00', restingMinutes: 30, timeMeta: parseShiftTime('16:00-00:00') },
                    'D▲': { count: 1, timeSlot: '08:00-16:00', restingMinutes: 30, timeMeta: parseShiftTime('08:00-16:00') },
                }
            };
            
            preAssignedShifts = {};
            window.staffStats = {};

            document.getElementById('restShiftName').value = '休';
            document.getElementById('staffNames').value = "莉娟\n麗雯\n佩君\n欣怡\n婉霏\n冠汝\n文雄\n芬萍\n勇得\n詣勛\n丁丁\n婷瑩\n芷芸\n惠琳\n琦崴\n俊穎\n鈺珊\n乙玲\n宛淇";
            
            // --- START: 設定預設特休結餘 (時數) ---
            const defaultAnnualLeaveBalanceText = `莉娟: 162
麗雯: 222
佩君: 237
欣怡: 240
婉霏: 240
冠汝: 240
文雄: 240
芬萍: 236
勇得: 229
詣勛: 115
丁丁: 114
婷瑩: 112
芷芸: 112
惠琳: 112
琦崴: 88
俊穎: 76
鈺珊: 66
乙玲: 29
宛淇: 24`;
            document.getElementById('annualLeaveBalanceText').value = defaultAnnualLeaveBalanceText; // NEW: 設定預設特休結餘 (時數)
            // --- END: 設定預設特休結餘 (時數) ---
            
            document.getElementById('settlementHoursText').value = ""; // NEW: 清空結算時數
            document.getElementById('monthlyStandardHours').value = '176'; // NEW: Default base hours

            // 預設將人員分派到新組別
            const initialStaffList = document.getElementById('staffNames').value.trim().split('\n').map(name => name.trim()).filter(name => name.length > 0);
            const initialSD = initialStaffList[3] || ''; // 欣怡
            const initialRC = initialStaffList[4] || ''; // 婉霏
            const initialReg1 = initialStaffList[5] || ''; // 冠汝
            const initialReg2 = initialStaffList[6] || ''; // 文雄
            // NEW: Default Previous month staff (use rotation staff as fallback)
            const initialPrevSD = initialStaffList[7] || ''; // 芬萍
            const initialPrevRC = initialStaffList[8] || ''; // 勇得


            document.getElementById('serviceDeskStaffSelect').value = initialSD;
            document.getElementById('referralCenterStaffSelect').value = initialRC;
            document.getElementById('regStaff1Select').value = initialReg1;
            document.getElementById('regStaff2Select').value = initialReg2;
            document.getElementById('prevSdStaffSelect').value = initialPrevSD; 
            document.getElementById('prevRcStaffSelect').value = initialPrevRC; 

            window.parseStaffData();
            window.renderSelectedDates();
            window.drawShiftInputsFromRequirements();
            window.populateShiftDatalist();
            window.renderPreAssignedShifts();
            window.populateAllDropdowns(); // RENAME
            window.validateInputs(); 
            window.renderShiftAvailability();
        };

        window.onload = () => {
            const today = new Date();
            const defaultDate = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
            document.getElementById('singleDateInput').value = defaultDate;
            document.getElementById('monthStartInput').value = defaultDate;

            window.parseStaffData();

            if (!window.initFirebase) {
                console.log("Firebase not detected, loading default data directly.");
                window.initDefaultData();
                window.populateAllDropdowns(); // RENAME
            }
            
            document.getElementById('staffNames').addEventListener('input', () => {
                window.parseStaffData();
                window.renderCarryOverInputs(); 
                window.renderAnnualLeaveInputs();
                window.renderSettlementHoursInputs();
                window.debounceSave();
            });
            
            // Add listeners for the group selections to force parseData and re-render the balance inputs
            document.getElementById('serviceDeskStaffSelect').addEventListener('change', window.debounceSave);
            document.getElementById('referralCenterStaffSelect').addEventListener('change', window.debounceSave);
            document.getElementById('regStaff1Select').addEventListener('change', window.debounceSave);
            document.getElementById('regStaff2Select').addEventListener('change', window.debounceSave);


            window.populateAllDropdowns(); // RENAME
            window.populateShiftDatalist();
            window.renderShiftAvailability();
        }

    </script>
</body>
</html>
